<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>partitioning.Partitioning &#8212; Partitioning 1.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/pd.css?v=b6646a53" />
    <script src="../../_static/documentation_options.js?v=292eb321"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <script type="text/javascript" src="../../_static/pd.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

  </head><body>
    <div id="header">
        <h1>Partitioning 1.0.1 documentation</h1>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
        <ul>
            <li class="nav-item nav-item-0"><a href="../../index.html">Partitioning 1.0.1 documentation</a> &#187;
            </li>
                <li class="nav-item nav-item-1"><a href="../index.html"
                        accesskey="U">Module code</a> &#187;</li>
        </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
<h1>Source code for partitioning.Partitioning</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">pint</span>
<span class="kn">from</span> <span class="nn">.auxfunctions</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ci_const_ppm</span><span class="p">,</span>
    <span class="n">cica_const_ratio</span><span class="p">,</span>
    <span class="n">cica_linear</span><span class="p">,</span>
    <span class="n">cica_sqrt</span><span class="p">,</span>
    <span class="n">sat_vapor_press</span><span class="p">,</span>
    <span class="n">vapor_press_deficit</span><span class="p">,</span>
    <span class="n">vapor_press_deficit_mass</span><span class="p">,</span>
    <span class="n">LinearDetrend</span><span class="p">,</span>
    <span class="n">Stats5min</span><span class="p">,</span>
    <span class="n">find_spikes</span><span class="p">,</span>
    <span class="n">FilterLowFrequencies</span><span class="p">,</span>
    <span class="n">max_time_lag_crosscorrel</span><span class="p">,</span>
    <span class="n">Constants</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Create a unit registry</span>
<span class="n">ureg</span> <span class="o">=</span> <span class="n">pint</span><span class="o">.</span><span class="n">UnitRegistry</span><span class="p">()</span>


<div class="viewcode-block" id="Partitioning">
<a class="viewcode-back" href="../../modules.html#partitioning.Partitioning.Partitioning">[docs]</a>
<span class="k">class</span> <span class="nc">Partitioning</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the Partitioning class.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hi : float</span>
<span class="sd">        Canopy height (m).</span>
<span class="sd">    zi : float</span>
<span class="sd">        Eddy covariance measurement height (m).</span>
<span class="sd">    freq : int</span>
<span class="sd">        Sampling frequency (Hz).</span>
<span class="sd">    length : int</span>
<span class="sd">        Length of the time series (in minutes).</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame with data (e.g., 30min intervals, but any length works), each variable in a column.</span>
<span class="sd">        If raw data is used, pre-processing is first implemented following these steps:</span>
<span class="sd">           - Quality control (removing outliers, despiking, flags of instruments, etc)</span>
<span class="sd">           - Rotation of coordinates (double rotation) for velocity components u, v, w measured by CSAT</span>
<span class="sd">           - Density corrections for instantaneous fluctuations of CO2 (c_p) and H2O (q_p) measured by open-gas analyser</span>
<span class="sd">             (&quot;instantaneous&quot; WPL correction) based on the paper: Detto, M. and Katul, G. G., 2007. &quot;Simplified expressions for adjusting higher-order</span>
<span class="sd">              turbulent statistics obtained from open path gas analyzers&quot;. Boundary-Layer Meteorology, 10.1007/s10546-006-9105-1</span>
<span class="sd">           - Turbulent fluctuations, here denoted as primed quantities (&quot;_p&quot;), are computed</span>
<span class="sd">           - Air temperature (T) and virtual temperature (Tv) computed from the sonic temperature (Ts)</span>

<span class="sd">        Raw data requires the following variables and units:</span>
<span class="sd">            - index : datetime</span>
<span class="sd">            - w : velocity in the z direction (m/s)</span>
<span class="sd">            - u : velocity in the x direction (m/s)</span>
<span class="sd">            - v : velocity in the y direction (m/s)</span>
<span class="sd">            - Ts : sonic temperature (Celsius)</span>
<span class="sd">            - P : pressure (kPa)</span>
<span class="sd">            - CO2 : carbon dioxide density (mg/m3)</span>
<span class="sd">            - H2O : water vapor density (g/m3)</span>

<span class="sd">        After pre-processing, the following additional variables are created:</span>
<span class="sd">            - w_p : fluctuations of velocity in the z direction (m/s)</span>
<span class="sd">            - u_p : fluctuations of velocity in the x direction (m/s)</span>
<span class="sd">            - v_p : fluctuations of velocity in the y direction (m/s)</span>
<span class="sd">            - T : thermodynamic air temperature (Celsius)</span>
<span class="sd">            - Tv : virtual temperature (Celsius)</span>
<span class="sd">            - co2_p : fluctuations of carbon dioxide density (mg/m3) - (corrected for external densities (WPL) if needed)</span>
<span class="sd">            - h2o_p : fluctuations of water vapor density (g/m3) - (corrected for external densities (WPL) if needed)</span>
<span class="sd">            - Ts_p : fluctuations of sonic air temperature (Celsius)</span>
<span class="sd">            - Tv_p : fluctuations of virtual temperature (Celsius)</span>

<span class="sd">    PreProcessing : bool, optional</span>
<span class="sd">        Indicates if pre-processing is necessary. If True, all pre-processing steps are implemented to raw data. If False,</span>
<span class="sd">        pre-processing is ignored and partitioning is immediately applied. In this case, the input files must contain all</span>
<span class="sd">        pre-processed variables listed above.</span>

<span class="sd">    argsQC : dict, optional</span>
<span class="sd">        Contains options to be used during pre-processing regarding fluctuation extraction and if density corrections are</span>
<span class="sd">        necessary. All options have default values, but can be modified if needed.</span>

<span class="sd">        Keys</span>
<span class="sd">        -----</span>
<span class="sd">            density_correction - bool</span>
<span class="sd">                True if density corrections are necessary (open gas analyzer); False (closed or enclosed gas analyzer).</span>
<span class="sd">            fluctuations - str</span>
<span class="sd">                Describes the type of operation used to extract fluctuations:</span>
<span class="sd">                &#39;BA&#39;: block average</span>
<span class="sd">                &#39;LD&#39;: Linear detrending</span>
<span class="sd">                &#39;FL&#39;: Filter low frequencies. Requires filtercut to indicate the cutoff time in minutes.</span>
<span class="sd">            filtercut - int</span>
<span class="sd">                Cutoff time in minutes for the low-pass filter. Only used if method is &#39;FL&#39;.</span>
<span class="sd">            maxGapsInterpolate - int</span>
<span class="sd">                Number of consecutive gaps that will be interpolated.</span>
<span class="sd">            RemainingData - int</span>
<span class="sd">                Percentage (0-100) of the time series that should remain after pre-processing. If less than this quantity, partitioning is not implemented.</span>
<span class="sd">            steadyness - bool</span>
<span class="sd">                If True, Foken&#39;s stationarity test is implemented to check if the data is stationary. If False, the test is not</span>
<span class="sd">                implemented. The test is only informative and does not remove data, which is left to the user&#39;s discretion.</span>
<span class="sd">            saveprocessed - bool</span>
<span class="sd">                If True, the processed data is saved to a CSV file.</span>
<span class="sd">            time_lag_correction - bool</span>
<span class="sd">                If True, a time lag correction is applied to the CO2 and H2O time series relative to the W time series.</span>
<span class="sd">            max_lag_seconds - int</span>
<span class="sd">                Maximum time lag in seconds to consider for correlation. Defaults to 5 seconds.</span>
<span class="sd">            type_lag - str</span>
<span class="sd">                Specifies the type of lag to consider. Options are &#39;positive&#39;, &#39;negative&#39;, or &#39;both&#39;. Defaults to &#39;positive&#39;.</span>
<span class="sd">                &#39;Positive&#39; means that CO2 and H2O lag behind W as expected in closed-path systems when the tube delays the signal.</span>


<span class="sd">    Notes: Available Partitioning Methods</span>
<span class="sd">        - Conditional Eddy Covariance (CEC)</span>
<span class="sd">        - Modified Relaxed Eddy Accumulation (MREA)</span>
<span class="sd">        - Flux Variance Similarity (FVS)</span>
<span class="sd">        - Conditional Eddy Accumulation (CEA)</span>
<span class="sd">        - Conditional Eddy Covariance + WUE (CECw)</span>

<span class="sd">    CEC, CEA, and MREA only need time series of w_p, co2_p, h2o_p. The remaining quantities (e.g., P, T, Tv, etc.) are only needed if the</span>
<span class="sd">    water use efficiency (WUE) is computed for the FVS and CECw method. Alternatively, an external WUE can be used; in this case, FVS and CECw</span>
<span class="sd">    will only need time series of w_p, h2o_p, co2_p.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">zi</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">PreProcessing</span><span class="p">,</span> <span class="n">argsQC</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hi</span> <span class="o">=</span> <span class="n">hi</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zi</span> <span class="o">=</span> <span class="n">zi</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">minute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_argsQC</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;time_lag_correction&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># If True, a time lag correction is applied to the CO2 and H2O time series relative to the W time series</span>
            <span class="s2">&quot;max_lag_seconds&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># Maximum time lag in seconds to consider for correlation</span>
            <span class="s2">&quot;saveplotlag&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># If True, saves a plot of the cross-correlation function between the CO2 and H2O time series with respect to the W time series</span>
            <span class="s2">&quot;type_lag&quot;</span><span class="p">:</span> <span class="s2">&quot;positive&quot;</span><span class="p">,</span>  <span class="c1"># Specifies the type of lag to consider (&#39;negative&#39;, &#39;positive&#39;, or &#39;both&#39;)</span>
            <span class="s2">&quot;fluctuations&quot;</span><span class="p">:</span> <span class="s2">&quot;LD&quot;</span><span class="p">,</span>  <span class="c1"># Method to compute fluctuations: &#39;LD&#39; (linear detrending), &#39;BA&#39; (block average), &#39;FL&#39; (filter low frequencies)</span>
            <span class="s2">&quot;filtercut&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># Cutoff timescale to filter low frequencies (in minutes). Needed when FL is selected as fluctuation method</span>
            <span class="s2">&quot;density_correction&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># If True, density corrections are implemented during pre-processing (depends on type of gas analyzer used)</span>
            <span class="s2">&quot;maxGapsInterpolate&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># Intervals of up to 5 missing values are filled by linear interpolation</span>
            <span class="s2">&quot;RemainingData&quot;</span><span class="p">:</span> <span class="mi">95</span><span class="p">,</span>  <span class="c1"># Only proceed with partioning if 95% of initial data is available after pre-processing</span>
            <span class="s2">&quot;steadyness&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># Compute statistic to check stationarity (will not delete data based on this test)</span>
            <span class="s2">&quot;saveprocessed&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># If True, save the intermediate processed data including all corrections and fluctuations</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">default_argsQC</span><span class="p">,</span> <span class="o">**</span><span class="n">argsQC</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Raw data</span>
            <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;Ts&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">degC</span><span class="p">,</span>
            <span class="s2">&quot;co2&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;h2o&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">gram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;Tair&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">degC</span><span class="p">,</span>
            <span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">kilopascal</span><span class="p">,</span>
            <span class="c1"># Variables computed during pre-processing</span>
            <span class="s2">&quot;w_p&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;u_p&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;v_p&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;T&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">degC</span><span class="p">,</span>
            <span class="s2">&quot;Tv&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">degC</span><span class="p">,</span>
            <span class="s2">&quot;co2_p&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;h2o_p&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">gram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
            <span class="s2">&quot;Ts_p&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
            <span class="s2">&quot;Tv_p&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
            <span class="s2">&quot;rho_moist_air&quot;</span><span class="p">:</span> <span class="n">ureg</span><span class="o">.</span><span class="n">kilogram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_checkMissingdata</span><span class="p">(</span><span class="n">percData</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RemainingData&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkUnits</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">PreProcessing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_checkPhysicalBounds</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_despike</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rotation</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time_lag_correction&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time_lag_correction</span><span class="p">(</span>
                    <span class="n">max_lag_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_lag_seconds&quot;</span><span class="p">),</span>
                    <span class="n">type_lag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type_lag&quot;</span><span class="p">),</span>
                    <span class="n">saveplotlag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;saveplotlag&quot;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fluctuations</span><span class="p">(</span>
                <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fluctuations&quot;</span><span class="p">),</span>
                <span class="n">filter_cut</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filtercut&quot;</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;density_correction&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_densityCorrections</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fluctuations&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fillGaps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;maxGapsInterpolate&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;steadyness&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_steadynessTest</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_checkMissingdata</span><span class="p">(</span><span class="n">percData</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">argsQC</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;RemainingData&quot;</span><span class="p">),</span> <span class="n">dropna_</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_checkUnits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if units of temperature, CO2, H2O and pressure are correct.&quot;&quot;&quot;</span>
        <span class="n">temp_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">70</span><span class="p">]</span>  <span class="c1"># C</span>
        <span class="n">co2_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1200</span><span class="p">]</span>  <span class="c1"># mg/m3</span>
        <span class="n">h2o_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>  <span class="c1"># g/m3</span>
        <span class="n">press_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">150</span><span class="p">]</span>  <span class="c1"># kPa</span>

        <span class="c1"># Check that not all values are NaN</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">mean_Ts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Ts&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][</span><span class="s2">&quot;Ts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">mean_co2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][</span><span class="s2">&quot;co2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">mean_h2o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][</span><span class="s2">&quot;h2o&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">mean_P</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">][</span><span class="s2">&quot;P&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">temp_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mean_Ts</span> <span class="o">&lt;</span> <span class="n">temp_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mean sonic temperature </span><span class="si">{</span><span class="n">mean_Ts</span><span class="si">}</span><span class="s2"> not in Celsius or data quality is poor</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">co2_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mean_co2</span> <span class="o">&lt;</span> <span class="n">co2_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mean CO2 </span><span class="si">{</span><span class="n">mean_co2</span><span class="si">}</span><span class="s2"> not in mg/m3 or data quality is poor</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">h2o_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mean_h2o</span> <span class="o">&lt;</span> <span class="n">h2o_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mean H2O </span><span class="si">{</span><span class="n">mean_h2o</span><span class="si">}</span><span class="s2"> not in g/m3 or data quality is poor</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">press_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mean_P</span> <span class="o">&lt;</span> <span class="n">press_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mean atm pressure </span><span class="si">{</span><span class="n">mean_P</span><span class="si">}</span><span class="s2"> not in kPa or data quality is poor</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_checkMissingdata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">percData</span><span class="p">,</span> <span class="n">dropna_</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks how many missing points are present and only accepts periods when valid data points &gt;= percData.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        percData : int</span>
<span class="sd">            Percentage of the data that needs to be valid (i.e., excluding gaps) in order to implement partitioning.</span>
<span class="sd">            If less than percData is available, the entire half-hour period is discarded. Must be between 0 and 100.</span>

<span class="sd">        Stores</span>
<span class="sd">        ------</span>
<span class="sd">        self.valid_data : float</span>
<span class="sd">            The percentage of valid data points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">maxNAN</span><span class="p">,</span> <span class="n">indMAX</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># noqa: F841</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">idxmax</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="mi">60</span>
        <span class="p">)</span>  <span class="c1"># total number of points in period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">valid_data</span> <span class="o">=</span> <span class="p">((</span><span class="n">total_size</span> <span class="o">-</span> <span class="n">maxNAN</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_size</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">valid_data</span> <span class="o">&lt;</span> <span class="n">percData</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;*** Too many missing points </span><span class="si">{</span><span class="n">maxNAN</span><span class="si">}</span><span class="s2">. Less than </span><span class="si">{</span><span class="n">percData</span><span class="si">}</span><span class="s2">\% is available for partitioning. Delete period and try again.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">dropna_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_checkPhysicalBounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets values outside a physically realistic range to NaN.</span>

<span class="sd">        If additional variables other than the required ones are passed to the code, their physical bounds need to be</span>
<span class="sd">        added to the dictionary `_bounds`. Units must match those of the input data.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        self.data : pandas.DataFrame</span>
<span class="sd">            DataFrame containing the input data with each variable in a column.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The `_bounds` dictionary contains the physical bounds for the required variables:</span>
<span class="sd">            - &quot;u&quot; : (-20, 20) m/s</span>
<span class="sd">            - &quot;v&quot; : (-20, 20) m/s</span>
<span class="sd">            - &quot;w&quot; : (-20, 20) m/s</span>
<span class="sd">            - &quot;Ts&quot; : (-10, 50) Celsius</span>
<span class="sd">            - &quot;co2&quot; : (0, 1500) mg/m3</span>
<span class="sd">            - &quot;h2o&quot; : (0, 40) g/m3</span>
<span class="sd">            - &quot;P&quot; : (60, 150) kPa</span>

<span class="sd">        For each variable in `self.data`, if the variable is in `_bounds`, values outside the specified bounds are set to NaN.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_bounds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;u&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
            <span class="s2">&quot;v&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
            <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>  <span class="c1"># m/s</span>
            <span class="s2">&quot;Ts&quot;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>  <span class="c1"># Celsius</span>
            <span class="s2">&quot;co2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1500</span><span class="p">),</span>  <span class="c1"># mg/m3</span>
            <span class="s2">&quot;h2o&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">),</span>  <span class="c1">#  g/m3</span>
            <span class="s2">&quot;P&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span>  <span class="c1"># kPa</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">_var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_var</span> <span class="ow">in</span> <span class="n">_bounds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">_var</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_bounds</span><span class="p">[</span><span class="n">_var</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="o">|</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">_var</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">_bounds</span><span class="p">[</span><span class="n">_var</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="n">_var</span><span class="p">,</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">def</span> <span class="nf">_despike</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replaces outliers with NaN values.</span>

<span class="sd">        Points are only considered outliers if no more than 8 points in sequence are above a threshold (see `find_spikes`</span>
<span class="sd">        in `auxfunctions.py`). Implements the test described in section 3.4 of:</span>

<span class="sd">            E. Zahn, T. L. Chor, N. L. Dias, A Simple Methodology for Quality Control of Micrometeorological Datasets,</span>
<span class="sd">            American Journal of Environmental Engineering, Vol. 6 No. 4A, 2016, pp. 135-142. doi: 10.5923/s.ajee.201601.20</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        self.data : pandas.DataFrame</span>
<span class="sd">            DataFrame containing the input data with each variable in a column.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The following steps are performed:</span>

<span class="sd">        1. Linear detrend of time series for variables: &quot;co2&quot;, &quot;h2o&quot;, &quot;Ts&quot;, &quot;w&quot;, &quot;u&quot;, &quot;v&quot;.</span>
<span class="sd">        2. Separation into 2-minute windows.</span>
<span class="sd">        3. Identification and replacement of spikes with NaN values for the above variables.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;co2&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o&quot;</span><span class="p">,</span> <span class="s2">&quot;Ts&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="s2">&quot;co2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># 1st: linear detrend time series ------------------</span>
        <span class="k">for</span> <span class="n">_var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;co2&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o&quot;</span><span class="p">,</span> <span class="s2">&quot;Ts&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]:</span>
            <span class="n">aux</span><span class="p">[</span><span class="n">_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearDetrend</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">aux</span><span class="p">[</span><span class="n">_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">tt</span>

        <span class="c1"># 2nd: Separate into 2-min windows -----------------</span>
        <span class="n">TwoMinGroups</span> <span class="o">=</span> <span class="n">aux</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;5Min&quot;</span><span class="p">))</span>
        <span class="n">TwoMinGroups</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">TwoMinGroups</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">TwoMinGroups</span><span class="o">.</span><span class="n">groups</span>
            <span class="k">if</span> <span class="n">TwoMinGroups</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10</span>
        <span class="p">]</span>
        <span class="k">del</span> <span class="n">aux</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TwoMinGroups</span><span class="p">)):</span>
            <span class="n">aux_group</span> <span class="o">=</span> <span class="n">TwoMinGroups</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">getSpikes</span> <span class="o">=</span> <span class="n">aux_group</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">find_spikes</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">_var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;co2&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o&quot;</span><span class="p">,</span> <span class="s2">&quot;Ts&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">vdate</span> <span class="ow">in</span> <span class="n">getSpikes</span><span class="p">[</span><span class="n">_var</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">vdate</span><span class="p">,</span> <span class="n">_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">del</span> <span class="n">TwoMinGroups</span>

    <span class="k">def</span> <span class="nf">_rotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs rotation of coordinates using the double rotation method.</span>

<span class="sd">        Overwrites the velocity field (u, v, w) with the rotated coordinates.</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        [Include relevant references here]</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        self.data : pandas.DataFrame</span>
<span class="sd">            DataFrame containing the input data with velocity components u, v, and w.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The double rotation method aligns the coordinate system with the mean flow direction. The steps involved are:</span>

<span class="sd">        1. Calculation of mean velocities.</span>
<span class="sd">        2. Calculation of the angles between mean velocities.</span>
<span class="sd">        3. Rotation of coordinates using these angles.</span>
<span class="sd">        4. Updating the DataFrame with the rotated velocities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Umean</span> <span class="o">=</span> <span class="n">aux</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="c1"># Calculating the angles between mean velocities</span>
        <span class="n">hspeed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Umean</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">Umean</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">alfax</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">Umean</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">],</span> <span class="n">Umean</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">])</span>
        <span class="n">alfaz</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">Umean</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">],</span> <span class="n">hspeed</span><span class="p">)</span>
        <span class="c1"># Rotating coordinates</span>
        <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;u_new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alfax</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alfaz</span><span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfax</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alfaz</span><span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfaz</span><span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;v_new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfax</span><span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alfax</span><span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span>
        <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;w_new&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alfax</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfaz</span><span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span>
            <span class="o">-</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfax</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">alfaz</span><span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">alfaz</span><span class="p">)</span> <span class="o">*</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># Update rotated velocities in dataframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;w_new&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;u_new&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;v_new&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">aux</span><span class="p">,</span> <span class="n">hspeed</span><span class="p">,</span> <span class="n">alfax</span><span class="p">,</span> <span class="n">alfaz</span>

    <span class="k">def</span> <span class="nf">_time_lag_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_lag_seconds</span><span class="p">,</span> <span class="n">type_lag</span><span class="p">,</span> <span class="n">saveplotlag</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Corrects the time lag between the &#39;co2&#39; and &#39;h2o&#39; time series relative to the &#39;w&#39; time series</span>
<span class="sd">           by shifting the &#39;co2&#39; and &#39;h2o&#39; time series accordingly while keeping the &#39;w&#39; time series fixed.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - max_lag_seconds (int): The maximum time lag in seconds to consider for correlation. Defaults to 5 seconds.</span>
<span class="sd">        - type_lag (str): Specifies the type of lag to consider. Options are &#39;positive&#39;, &#39;negative&#39;, or &#39;both&#39;.</span>
<span class="sd">                          Defaults to &#39;positive&#39;, meaning only positive lags will be considered, implying that co2 and h2o lag behind w</span>
<span class="sd">        - saveplotlag (bool): If True, saves a plot of the cross-correlation function between the &#39;co2&#39; and &#39;h2o&#39; time series with respect to the &#39;w&#39; time series.</span>

<span class="sd">        This method calculates the optimal lag for the &#39;co2&#39; and &#39;h2o&#39; time series with respect to the &#39;w&#39; time series</span>
<span class="sd">        and shifts them accordingly to align with the &#39;w&#39; time series. The lags are determined by finding the maximum</span>
<span class="sd">        absolute correlation.</span>

<span class="sd">        Returns:</span>
<span class="sd">        - None: The method updates the &#39;co2&#39; and &#39;h2o&#39; columns in the instance&#39;s data attribute in place.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lag_co2</span><span class="p">,</span> <span class="n">lag_h2o</span> <span class="o">=</span> <span class="n">max_time_lag_crosscorrel</span><span class="p">(</span>
            <span class="n">df</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;co2&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">]],</span>
            <span class="n">sampling_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
            <span class="n">max_lag_seconds</span><span class="o">=</span><span class="n">max_lag_seconds</span><span class="p">,</span>
            <span class="n">type_lag</span><span class="o">=</span><span class="n">type_lag</span><span class="p">,</span>
            <span class="n">saveplotlag</span><span class="o">=</span><span class="n">saveplotlag</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">lag_co2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="n">lag_h2o</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fluctuations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">filter_cut</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes turbulent fluctuations, x&#39; = x - X, where X is the average.</span>

<span class="sd">        Only variables required by the partitioning algorithms are included.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str</span>
<span class="sd">            Method to compute X:</span>
<span class="sd">            &#39;BA&#39; : Block average</span>
<span class="sd">            &#39;FL&#39; : Filter low frequencies above filter_cut (in min)</span>
<span class="sd">            &#39;LD&#39; : Linear detrending</span>
<span class="sd">        filter_cut : int</span>
<span class="sd">            Cutoff time in minutes for the low-pass filter. Only used if method is &#39;FL&#39;.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If the method to extract fluctuations is not &#39;LD&#39; or &#39;BA&#39;.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        self.data : pandas.DataFrame</span>
<span class="sd">            DataFrame containing the input data with variables &quot;u&quot;, &quot;v&quot;, &quot;w&quot;, &quot;co2&quot;, &quot;h2o&quot;, &quot;Ts&quot;.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Adds the time series of fluctuations (variable_name + &#39;_p&#39;) to the DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Lvars</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;co2&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o&quot;</span><span class="p">,</span> <span class="s2">&quot;Ts&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;LD&quot;</span><span class="p">:</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">_var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Lvars</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">_var</span> <span class="o">+</span> <span class="s2">&quot;_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearDetrend</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">tt</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;FL&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">_var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Lvars</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">_var</span> <span class="o">+</span> <span class="s2">&quot;_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FilterLowFrequencies</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span> <span class="n">filter_cut</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;BA&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">_var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Lvars</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">_var</span> <span class="o">+</span> <span class="s2">&quot;_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">_var</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">_var</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Method to extract fluctuations must be &#39;LD&#39;, &#39;BA&#39; or &#39;FL </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_densityCorrections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies density correction to the fluctuations of CO2 (co2_p) and H2O (h2o_p).</span>

<span class="sd">        Follows the method described in:</span>
<span class="sd">            Detto, M. and Katul, G. G., 2007. &quot;Simplified expressions for adjusting higher-order turbulent statistics obtained from open path gas analyzers&quot;,</span>
<span class="sd">            Boundary-Layer Meteorology, 10.1007/s10546-006-9105-1.</span>

<span class="sd">        Note that this correction is necessary only when CO2 and H2O were measured by an open gas analyzer and their outputs are mass/molar densities (e.g., mg/m3).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str</span>
<span class="sd">            Method to compute temperature fluctuations:</span>
<span class="sd">            &#39;LD&#39; : Linear detrending</span>
<span class="sd">            &#39;BA&#39; : Block average</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        self.data : pandas.DataFrame</span>
<span class="sd">            DataFrame containing the input data with variables &quot;P&quot;, &quot;Ts&quot;, &quot;co2&quot;, &quot;h2o&quot;, &quot;u&quot;, &quot;v&quot;, &quot;w&quot;.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Calculates air density, thermodynamic temperature, and virtual temperature.</span>
<span class="sd">        - Computes temperature fluctuations based on the specified method.</span>
<span class="sd">        - Applies corrections to CO2 and H2O fluctuations using the specified method.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If the method to compute temperature fluctuations is not &#39;LD&#39; or &#39;BA&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate air density------------------------------------------------</span>
        <span class="n">Rd</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Rd</span><span class="o">.</span><span class="n">magnitude</span>  <span class="c1"># J/kg.K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rho_moist_air&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">1000</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">Rd</span> <span class="o">*</span> <span class="p">(</span><span class="mf">273.15</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Ts&quot;</span><span class="p">]))</span>
        <span class="p">)</span>  <span class="c1"># mean density of moist air [kg/m3] *** assume Ts is the same as Tv ***</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rho_dry_air&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rho_moist_air&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>
        <span class="p">)</span>  <span class="c1"># density of dry air [kg/m3]</span>
        <span class="c1"># Obtain termodynamic and virtual temperatures ------------------------</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rho_dry_air&quot;</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># Instantaneous mixing ratio kg/kg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Ts&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
            <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.51</span> <span class="o">*</span> <span class="n">q</span>
        <span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span>  <span class="c1"># termodynamic temperature from sonic temperature [C]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Tv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span>
            <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">0.61</span> <span class="o">*</span> <span class="n">q</span>
        <span class="p">)</span> <span class="o">-</span> <span class="mf">273.15</span>  <span class="c1"># virtual temperature from termo temperature [C]</span>

        <span class="c1"># We also need the fluctuations of temperature ------------------------</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;LD&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearDetrend</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Tv_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LinearDetrend</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Tv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Tv_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Tv&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Tv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">meanT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># mean real temperature [C]</span>

        <span class="c1"># Aditional variables --------------------------------------------------</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Constants</span><span class="o">.</span><span class="n">MWdryair</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">/</span> <span class="n">Constants</span><span class="o">.</span><span class="n">MWvapor</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>  <span class="c1"># ratio of dry air mass to water vapor mass</span>
        <span class="n">mean_co2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">6</span>  <span class="c1"># mean co2 [kg/m3]</span>
        <span class="n">mean_h2o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>  <span class="c1"># mean h2o [kg/m3]</span>
        <span class="n">sigmaq</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mean_h2o</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rho_dry_air&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># mixing ratio [kg_wv/kg_air]</span>
        <span class="n">sigmac</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mean_co2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rho_dry_air&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># mixing ratio [kg_co2/kg_air]</span>

        <span class="c1"># Finally, apply the corrections ---------------------------------------</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">(</span>
                <span class="n">mu</span> <span class="o">*</span> <span class="n">sigmac</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>
                <span class="o">+</span> <span class="n">mean_co2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">sigmaq</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">meanT</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
        <span class="p">)</span>  <span class="c1"># [mg/m3]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span>
            <span class="o">+</span> <span class="p">(</span>
                <span class="n">mu</span> <span class="o">*</span> <span class="n">sigmaq</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>
                <span class="o">+</span> <span class="n">mean_h2o</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">sigmaq</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;T_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">meanT</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="mi">1000</span>
        <span class="p">)</span>  <span class="c1"># [ g/m3]</span>
        <span class="k">del</span> <span class="n">mu</span><span class="p">,</span> <span class="n">mean_co2</span><span class="p">,</span> <span class="n">mean_h2o</span><span class="p">,</span> <span class="n">sigmaq</span><span class="p">,</span> <span class="n">sigmac</span><span class="p">,</span> <span class="n">q</span>

    <span class="k">def</span> <span class="nf">_fillGaps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxGaps</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills gaps (NaN values) in time series using linear interpolation.</span>

<span class="sd">        It is recommended that only small gaps be interpolated.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        maxGaps : int</span>
<span class="sd">            Number of consecutive missing gaps that can be interpolated. Should be 0 &lt; maxGaps &lt; 20.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TypeError</span>
<span class="sd">            If maxGaps is greater than 20, indicating that too many consecutive points are being interpolated.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        self.data : pandas.DataFrame</span>
<span class="sd">            DataFrame containing the input data with potential gaps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">maxGaps</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Too many consecutive points to be interpolated. Consider a smaller gap (up to 20 points). </span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">maxGaps</span><span class="p">,</span> <span class="n">limit_direction</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_steadynessTest</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements a stationarity test described in section 5 of:</span>
<span class="sd">            Thomas Foken and B. Wichura, &quot;Tools for quality assessment of surface-based flux measurements&quot;,</span>
<span class="sd">            Agricultural and Forest Meteorology, Volume 78, Issues 12, 1996, Pages 83-105.</span>

<span class="sd">        Computes the stationarity statistic:</span>
<span class="sd">            stat = | (average_cov_5min - cov_30min) / cov_30min | * 100 %</span>
<span class="sd">        where cov is the covariance between any two variables.</span>

<span class="sd">        Foken argues that steady state conditions can be assumed if stat &lt; 30 %.</span>
<span class="sd">        This variable can be used as a criterion for data quality and its compliance with EC requirements (steadiness).</span>

<span class="sd">        Reference:</span>
<span class="sd">        Foken, T., Micrometeorology, https://doi.org/10.1007/978-3-540-74666-9, p. 175.</span>

<span class="sd">        Creates a dictionary with the steadiness statistics (in %) for variances and covariances.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        self.FokenStatTest : dict</span>
<span class="sd">            Dictionary containing the steadiness statistics for various fluxes and variances:</span>
<span class="sd">            - &#39;wc&#39;: statistic for w&#39;c&#39; (total CO2 flux)</span>
<span class="sd">            - &#39;wq&#39;: statistic for w&#39;q&#39; (total H2O flux)</span>
<span class="sd">            - &#39;wT&#39;: statistic for w&#39;T&#39; (sonic temperature flux)</span>
<span class="sd">            - &#39;ww&#39;: statistic for w&#39;w&#39; (variance of w)</span>
<span class="sd">            - &#39;cc&#39;: statistic for c&#39;c&#39; (variance of CO2)</span>
<span class="sd">            - &#39;qq&#39;: statistic for q&#39;q&#39; (variance of H2O)</span>
<span class="sd">            - &#39;tt&#39;: statistic for t&#39;t&#39; (variance of sonic temperature)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        - Computes 5-minute window statistics.</span>
<span class="sd">        - Compares 30-minute statistics to the average of 5-minute windows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Five minute window statistics -------------------------</span>
        <span class="n">stats5min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s2">&quot;5Min&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">Stats5min</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">aver_5min</span> <span class="o">=</span> <span class="n">stats5min</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="c1"># Statistic for entire window (i.e., 30 min) ------------</span>
        <span class="n">cov_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
        <span class="n">var_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>
        <span class="n">stats_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">cov_all</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">][</span><span class="s2">&quot;co2_p&quot;</span><span class="p">],</span>
                <span class="n">cov_all</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">][</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">],</span>
                <span class="n">cov_all</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">][</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">],</span>
                <span class="n">var_all</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">],</span>
                <span class="n">var_all</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">],</span>
                <span class="n">var_all</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">],</span>
                <span class="n">var_all</span><span class="p">[</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;wc&quot;</span><span class="p">,</span> <span class="s2">&quot;wq&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="s2">&quot;ww&quot;</span><span class="p">,</span> <span class="s2">&quot;cc&quot;</span><span class="p">,</span> <span class="s2">&quot;qq&quot;</span><span class="p">,</span> <span class="s2">&quot;tt&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># Compare 30-min to 5-min windows -----------------------</span>
        <span class="n">stat_fk</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">abs</span><span class="p">((</span><span class="n">stats_all</span> <span class="o">-</span> <span class="n">aver_5min</span><span class="p">)</span> <span class="o">/</span> <span class="n">stats_all</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FokenStatTest</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fkstat_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">svar</span><span class="p">:</span> <span class="n">stat_fk</span><span class="p">[</span><span class="n">svar</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">svar</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;wc&quot;</span><span class="p">,</span> <span class="s2">&quot;wq&quot;</span><span class="p">,</span> <span class="s2">&quot;wt&quot;</span><span class="p">,</span> <span class="s2">&quot;ww&quot;</span><span class="p">,</span> <span class="s2">&quot;cc&quot;</span><span class="p">,</span> <span class="s2">&quot;qq&quot;</span><span class="p">,</span> <span class="s2">&quot;tt&quot;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="c1"># print results as a table with wc wq wt ww cc qq tt on top and their respective values below</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------------------&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Foken&#39;s Stationarity Test (%)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">FokenStatTest</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Partitioning.TurbulentStats">
<a class="viewcode-back" href="../../modules.html#partitioning.Partitioning.Partitioning.TurbulentStats">[docs]</a>
    <span class="k">def</span> <span class="nf">TurbulentStats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        # Calculate turbulent statistics (scales, standard deviations, and correlations).</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        self.turbstats : dict</span>

<span class="sd">            Keys:</span>
<span class="sd">            -----</span>
<span class="sd">                &#39;ustar&#39;: float</span>
<span class="sd">                    friction velocity [m/s]</span>
<span class="sd">                &#39;cstar&#39;: float</span>
<span class="sd">                    scale for CO2 [mg/m3]</span>
<span class="sd">                &#39;qstar&#39;: float</span>
<span class="sd">                    scale for H2O [g/m3]</span>
<span class="sd">                &#39;tstar&#39;: float</span>
<span class="sd">                    scale for temperature [K]</span>
<span class="sd">                &#39;zeta&#39;: float</span>
<span class="sd">                    Monin-Obukhov stability parameter</span>
<span class="sd">                &#39;std_t&#39;: float</span>
<span class="sd">                    standard deviation of temperature [K]</span>
<span class="sd">                &#39;std_q&#39;: float</span>
<span class="sd">                    standard deviation of H2O [g/m3]</span>
<span class="sd">                &#39;std_c&#39;: float</span>
<span class="sd">                    standard deviation of CO2 [mg/m3]</span>
<span class="sd">                &#39;std_w&#39;: float</span>
<span class="sd">                    standard deviation of w [m/s]</span>
<span class="sd">                &#39;std_u&#39;: float</span>
<span class="sd">                    standard deviation of u [m/s]</span>
<span class="sd">                &#39;std_v&#39;: float</span>
<span class="sd">                    floatstandard deviation of v [m/s]</span>
<span class="sd">                &#39;rqc&#39;: float</span>
<span class="sd">                    correlation between H2O and CO2</span>
<span class="sd">                &#39;rqt&#39;: float</span>
<span class="sd">                    correlation between H2O and temperature</span>
<span class="sd">                &#39;rct&#39;: float</span>
<span class="sd">                    correlation between CO2 and temperature</span>
<span class="sd">                &#39;Fc&#39;: float</span>
<span class="sd">                    covariance between w and CO2 [mg/m2/s]</span>
<span class="sd">                &#39;LE&#39;: float</span>
<span class="sd">                    latent heat flux [W/m2]</span>
<span class="sd">                &#39;H&#39;: float</span>
<span class="sd">                    sensible heat flux [W/m2]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;u_p&quot;</span><span class="p">,</span> <span class="s2">&quot;v_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">,</span> <span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;Ts_p&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">matrixCov</span> <span class="o">=</span> <span class="n">aux</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>  <span class="c1"># Covariance matrix</span>
        <span class="n">matrixSTD</span> <span class="o">=</span> <span class="n">aux</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>  <span class="c1"># Covariance matrix</span>
        <span class="n">matrixCorr</span> <span class="o">=</span> <span class="n">aux</span><span class="o">.</span><span class="n">corr</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;pearson&quot;</span><span class="p">)</span>  <span class="c1"># Correlation matrix</span>

        <span class="c1"># Calculate scales -------------------------------------------------------</span>
        <span class="n">ustar</span> <span class="o">=</span> <span class="p">(</span><span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;u_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">][</span><span class="s2">&quot;v_p&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span>
            <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">4.0</span>
        <span class="p">)</span>  <span class="c1"># Friction velocity [m/s]</span>
        <span class="n">cstar</span> <span class="o">=</span> <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">ustar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;co2&quot;</span><span class="p">]</span>  <span class="c1"># mg/m3</span>
        <span class="n">qstar</span> <span class="o">=</span> <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">ustar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;h2o&quot;</span><span class="p">]</span>  <span class="c1">#  g/m3</span>
        <span class="n">tstar</span> <span class="o">=</span> <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">ustar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">]</span>  <span class="c1"># K</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi</span>  <span class="c1"># Displacement height [m]</span>
        <span class="n">Qv</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># kinematic heat flux [K m/s]</span>
        <span class="n">meanTkelvin</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Tv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">]</span>
        <span class="n">rho_moist_air</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;rho_moist_air&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;rho_moist_air&quot;</span><span class="p">]</span>
        <span class="p">)</span>  <span class="c1"># kg/m3</span>
        <span class="n">LE_wm2</span> <span class="o">=</span> <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">][</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">LE_wm2</span> <span class="o">=</span> <span class="n">LE_wm2</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">H_wm2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">][</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">]</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">cp</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="o">*</span> <span class="n">rho_moist_air</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>
        <span class="n">H_wm2</span> <span class="o">=</span> <span class="n">H_wm2</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">zi</span><span class="o">.</span><span class="n">magnitude</span><span class="p">:</span>
            <span class="n">zeta</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="mf">0.4</span>
                <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zi</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">-</span> <span class="n">d</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">Qv</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="o">/</span> <span class="p">((</span><span class="n">meanTkelvin</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="n">ustar</span><span class="p">)</span> <span class="o">**</span> <span class="mi">3</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zeta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">turbstats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ustar&quot;</span><span class="p">:</span> <span class="n">ustar</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">],</span>
            <span class="s2">&quot;cstar&quot;</span><span class="p">:</span> <span class="n">cstar</span><span class="p">,</span>
            <span class="s2">&quot;qstar&quot;</span><span class="p">:</span> <span class="n">qstar</span><span class="p">,</span>
            <span class="s2">&quot;tstar&quot;</span><span class="p">:</span> <span class="n">tstar</span><span class="p">,</span>
            <span class="s2">&quot;zeta&quot;</span><span class="p">:</span> <span class="n">zeta</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">,</span>
            <span class="s2">&quot;std_t&quot;</span><span class="p">:</span> <span class="n">matrixSTD</span><span class="p">[</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">],</span>
            <span class="s2">&quot;std_q&quot;</span><span class="p">:</span> <span class="n">matrixSTD</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;h2o&quot;</span><span class="p">],</span>
            <span class="s2">&quot;std_c&quot;</span><span class="p">:</span> <span class="n">matrixSTD</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;co2&quot;</span><span class="p">],</span>
            <span class="s2">&quot;std_w&quot;</span><span class="p">:</span> <span class="n">matrixSTD</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">],</span>
            <span class="s2">&quot;std_u&quot;</span><span class="p">:</span> <span class="n">matrixSTD</span><span class="p">[</span><span class="s2">&quot;u_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">],</span>
            <span class="s2">&quot;std_v&quot;</span><span class="p">:</span> <span class="n">matrixSTD</span><span class="p">[</span><span class="s2">&quot;v_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">],</span>
            <span class="s2">&quot;rqc&quot;</span><span class="p">:</span> <span class="n">matrixCorr</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">][</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">,</span>
            <span class="s2">&quot;rqt&quot;</span><span class="p">:</span> <span class="n">matrixCorr</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">][</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">,</span>
            <span class="s2">&quot;rct&quot;</span><span class="p">:</span> <span class="n">matrixCorr</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">][</span><span class="s2">&quot;Ts_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">,</span>
            <span class="s2">&quot;Fc&quot;</span><span class="p">:</span> <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">][</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;co2&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">],</span>
            <span class="s2">&quot;LE&quot;</span><span class="p">:</span> <span class="n">LE_wm2</span><span class="p">,</span>
            <span class="s2">&quot;H&quot;</span><span class="p">:</span> <span class="n">H_wm2</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Partitioning.WaterUseEfficiency">
<a class="viewcode-back" href="../../modules.html#partitioning.Partitioning.Partitioning.WaterUseEfficiency">[docs]</a>
    <span class="k">def</span> <span class="nf">WaterUseEfficiency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ppath</span><span class="o">=</span><span class="s2">&quot;C3&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates water use efficiency in kg_co2/kg_h2o.</span>

<span class="sd">        Main references:</span>
<span class="sd">        - Scanlon and Sahu 2008, Water Resources Research</span>
<span class="sd">          &quot;On the correlation structure of water vapor and carbon dioxide in</span>
<span class="sd">          the atmospheric surface layer: A basis for flux partitioning&quot;</span>
<span class="sd">        - Parts of the code were adapted from Skaggs et al. 2018, Agr For Met</span>
<span class="sd">          &quot;Fluxpart: Open source software for partitioning carbon dioxide and water vapor fluxes&quot;</span>
<span class="sd">          https://github.com/usda-ars-ussl/fluxpart</span>
<span class="sd">        - Optimization model for W from Scanlon et al., 2019, Agr. For. Met.</span>
<span class="sd">          &quot;Correlation-based flux partitioning of water vapor and carbon dioxide fluxes:</span>
<span class="sd">          Method simplification and estimation of canopy water use efficiency&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ppath : str</span>
<span class="sd">            Type of photosynthesis (&#39;C3&#39; or &#39;C4&#39;).</span>

<span class="sd">        Models</span>

<span class="sd">            Computes the water use efficiency (eq A1 in Scanlon and Sahu, 2008):</span>
<span class="sd">                - wue = 0.65 * (c_c - c_s) / (q_c - q_s)</span>
<span class="sd">                - c_c (kg/m3) and q_c (kg/m3) are near canopy concentrations of CO2 and H2O</span>
<span class="sd">                    - Estimated from log profiles (eq A2a in Scanlon and Sahu, 2008).</span>
<span class="sd">                - c_s (kg/m3) and q_s (kg/m3) are stomata concentrations of CO2 and H2O</span>
<span class="sd">                    - q_s is assumed to be at saturation.</span>
<span class="sd">                    - c_s is parameterized from different models (Skaggs et al., 2018; Scanlon et al., 2019).</span>

<span class="sd">            The following models for c_s are implemented</span>

<span class="sd">            const_ppm:</span>
<span class="sd">                - Concentrations in kg/m3 are computed from a constant value in ppm.</span>
<span class="sd">                - Values from Campbell and Norman, 1998, p. 150.</span>
<span class="sd">                  Campbell, G. S. and Norman, J. M. (1998). An Introduction to Environmental Biophysics. Springer, New York, NY.</span>
<span class="sd">                - c_s = 280 ppm (C3 plants).</span>
<span class="sd">                - c_s = 130 ppm (C4 plants).</span>

<span class="sd">            const_ratio:</span>
<span class="sd">                - The ratio of near canopy and stomata CO2 concentrations is assumed constant (c_s/c_c = constant).</span>
<span class="sd">                - Constants from Sinclair, T. R., Tanner, C. B., and Bennett, J. M. (1984).</span>
<span class="sd">                  Water-use efficiency in crop production. BioScience, 34(1):3640.</span>
<span class="sd">                - c_s/c_c = 0.70 for C3 plants.</span>
<span class="sd">                - c_s/c_c = 0.44 for C4 plants.</span>

<span class="sd">            linear:</span>
<span class="sd">                - The ratio of near canopy and stomata CO2 concentrations is a linear function of VPD.</span>
<span class="sd">                - Based on the results of Morison, J. I. L. and Gifford, R. M. (1983).</span>
<span class="sd">                  Stomatal sensitivity to carbon dioxide and humidity. Plant Physiology, 71(4):789796.</span>
<span class="sd">                  Estimated constants from Skaggs et al (2018).</span>
<span class="sd">                - c_s/c_c = a - b * D</span>
<span class="sd">                - a, b = 1, 1.6*10-4 Pa-1 for C3 plants.</span>
<span class="sd">                - a, b = 1, 2.7*10-4 Pa-1 for C4 plants.</span>
<span class="sd">                - D (Pa) is vapor pressure deficit based on leaf-temperature.</span>

<span class="sd">            sqrt:</span>
<span class="sd">                - The ratio of near canopy and stomata CO2 concentrations is proportional</span>
<span class="sd">                  to the 1/2 power of VPD.</span>
<span class="sd">                - Model by Katul, G. G., Palmroth, S., and Oren, R. (2009).</span>
<span class="sd">                  Leaf stomatal responses to vapour pressure deficit under current and CO2-enriched atmosphere</span>
<span class="sd">                  explained by the economics of gas exchange. Plant, Cell &amp; Environment, 32(8):968979.</span>
<span class="sd">                - c_s/c_c = 1 - sqrt(1.6 * lambda * D / c_c)</span>
<span class="sd">                - lambda = 22e-9 kg-CO2 / m^3 / Pa for C3 plants (from Skaggs et al., 2018).</span>
<span class="sd">                - Not available for C4 plants.</span>

<span class="sd">            opt:</span>
<span class="sd">                - Optimization model proposed by Scanlon et al (2019).</span>
<span class="sd">                - Does not need extra parameters.</span>
<span class="sd">                - Only available for C3 plants.</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        self.wue : dict</span>
<span class="sd">            Dictionary containing the water use efficiency from different methods:</span>
<span class="sd">            - &#39;const_ppm&#39;: float</span>
<span class="sd">                WUE from constant ppm [kg_co2/kg_h2o].</span>
<span class="sd">            - &#39;const_ratio&#39;: float</span>
<span class="sd">                WUE from constant ratio [kg_co2/kg_h2o].</span>
<span class="sd">            - &#39;linear&#39;: float</span>
<span class="sd">                WUE from linear model [kg_co2/kg_h2o].</span>
<span class="sd">            - &#39;sqrt&#39;: float</span>
<span class="sd">                WUE from sqrt model [kg_co2/kg_h2o].</span>
<span class="sd">            - &#39;opt&#39;: float</span>
<span class="sd">                WUE from optimization model [kg_co2/kg_h2o].</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a copy of the dataframe with variables that will be needed</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Create dictionary that will store water use efficiency from different methods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wue</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;const_ppm&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;const_ratio&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;linear&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;sqrt&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;opt&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Statistics  --------------------</span>
        <span class="n">matrixCov</span> <span class="o">=</span> <span class="n">aux</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>  <span class="c1"># Covariance matrix</span>
        <span class="n">varq</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">][</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">6</span>
        <span class="p">)</span>  <span class="c1"># variance of h2o fluctuations (kg/m3)^2</span>
        <span class="n">varc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">][</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">12</span>
        <span class="p">)</span>  <span class="c1"># variance of co2 fluctuations (kg/m3)^2</span>
        <span class="n">sigmac</span> <span class="o">=</span> <span class="n">varc</span><span class="o">**</span><span class="mf">0.5</span>  <span class="c1"># Standard deviation of co2 [kg/m3]</span>
        <span class="n">sigmaq</span> <span class="o">=</span> <span class="n">varq</span><span class="o">**</span><span class="mf">0.5</span>  <span class="c1"># Standard deviation of h2o [kg/m3]</span>
        <span class="n">corr_qc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">aux</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)[</span>
            <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
        <span class="p">]</span>  <span class="c1"># correlation coefficient between q and c</span>
        <span class="n">cov_wq</span> <span class="o">=</span> <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">][</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>  <span class="c1"># covariance of w and q (kg/m^2/s);</span>
        <span class="n">cov_wc</span> <span class="o">=</span> <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">][</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">6</span>  <span class="c1"># covariance of w and c (kg/m^2/s);</span>

        <span class="c1"># Mean variables and parameterizations ------------</span>
        <span class="n">leaf_T</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;T&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">+</span> <span class="mf">273.15</span>
        <span class="p">)</span>  <span class="c1"># set leaf temperature == air temperature (Kelvin)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;P&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span>  <span class="c1"># mean atmospheric pressure (Pa)</span>
        <span class="n">mean_rho_vapor</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;h2o&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>
        <span class="p">)</span>  <span class="c1"># mean vapor density (kg/m^3) -- NOT THE FLUCTUATIONS!</span>
        <span class="n">mean_rho_co2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;co2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">6</span>
        <span class="p">)</span>  <span class="c1"># mean carbon dioxide concentration (kg/m^3) -- NOT THE FLUCTUATIONS!</span>
        <span class="n">mean_Tv</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;Tv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>  <span class="c1"># mean virtual temperature in Celsius</span>
        <span class="n">rho_totair</span> <span class="o">=</span> <span class="n">P</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">Constants</span><span class="o">.</span><span class="n">Rd</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="p">(</span><span class="n">mean_Tv</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># moist air density (kg/m^3)</span>
        <span class="n">ustar</span> <span class="o">=</span> <span class="p">(</span><span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;u_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">][</span><span class="s2">&quot;v_p&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span>
            <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">4.0</span>
        <span class="p">)</span>  <span class="c1"># friction velocity [m/s]</span>
        <span class="n">Qv</span> <span class="o">=</span> <span class="n">matrixCov</span><span class="p">[</span><span class="s2">&quot;Tv_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span>  <span class="c1"># kinematic virtual temperature flux [K m/s]</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># displacement height [m]</span>
        <span class="n">zeta</span> <span class="o">=</span> <span class="p">(</span>
            <span class="o">-</span><span class="n">Constants</span><span class="o">.</span><span class="n">VON_KARMAN</span>
            <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">g</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zi</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">-</span> <span class="n">dd</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">Qv</span>
            <span class="o">/</span> <span class="p">((</span><span class="n">mean_Tv</span> <span class="o">+</span> <span class="mf">273.15</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ustar</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
        <span class="p">)</span>  <span class="c1"># Monin-Obukhov stability parameter</span>
        <span class="n">zv</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">hi</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>  <span class="c1"># Roughness parameter</span>

        <span class="c1"># 1 - Finding near canopy concentrations --------------------------------------------------</span>
        <span class="c1"># Calculating Monin Obukhov nondimensional function</span>
        <span class="c1"># Following Fluxpart - Skaggs et al., 2018</span>

        <span class="c1"># Limiting zeta to avoid numerical errors</span>
        <span class="n">zeta_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span>
        <span class="n">zeta_max</span> <span class="o">=</span> <span class="mf">5.0</span>
        <span class="k">if</span> <span class="n">zeta</span> <span class="o">&lt;</span> <span class="n">zeta_min</span><span class="p">:</span>
            <span class="n">zeta</span> <span class="o">=</span> <span class="n">zeta_min</span>
        <span class="k">elif</span> <span class="n">zeta</span> <span class="o">&gt;</span> <span class="n">zeta_max</span><span class="p">:</span>
            <span class="n">zeta</span> <span class="o">=</span> <span class="n">zeta_max</span>

        <span class="k">if</span> <span class="n">zeta</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.04</span><span class="p">:</span>
            <span class="n">psi_v</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mf">16.0</span> <span class="o">*</span> <span class="n">zeta</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">zeta</span> <span class="o">&lt;=</span> <span class="mf">0.04</span><span class="p">:</span>
            <span class="n">psi_v</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi_v</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span> <span class="o">*</span> <span class="n">zeta</span>

        <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">zi</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">-</span> <span class="n">dd</span><span class="p">)</span> <span class="o">/</span> <span class="n">zv</span><span class="p">)</span> <span class="o">-</span> <span class="n">psi_v</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">Constants</span><span class="o">.</span><span class="n">VON_KARMAN</span>
            <span class="o">/</span> <span class="n">ustar</span>
        <span class="p">)</span>
        <span class="n">ambient_h2o</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mean_rho_vapor</span> <span class="o">+</span> <span class="n">cov_wq</span> <span class="o">*</span> <span class="n">arg</span>
        <span class="p">)</span>  <span class="c1"># mean h2o concentration near canopy [kg/m3] - using log-law profiles</span>
        <span class="n">ambient_co2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">mean_rho_co2</span> <span class="o">+</span> <span class="n">cov_wc</span> <span class="o">*</span> <span class="n">arg</span>
        <span class="p">)</span>  <span class="c1"># mean co2 concentration near canopy [kg/m3] - using log-law profiles</span>

        <span class="c1"># 2 - Finding intercelular concentrations -------------------------------------------------</span>
        <span class="n">esat</span> <span class="o">=</span> <span class="n">sat_vapor_press</span><span class="p">(</span>
            <span class="n">leaf_T</span>
        <span class="p">)</span>  <span class="c1"># Intercellular saturation vapor pressure &#39;esat&#39; [Pa]</span>

        <span class="c1"># Intercellular vapor density</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">MWvapor</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">/</span> <span class="n">Constants</span><span class="o">.</span><span class="n">MWdryair</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="n">inter_h2o</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">rho_totair</span> <span class="o">*</span> <span class="n">eps</span> <span class="o">*</span> <span class="n">esat</span> <span class="o">/</span> <span class="p">(</span><span class="n">P</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">esat</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># mean h2o concentration inside stomata [kg/m3]</span>

        <span class="c1"># vapor pressure deficit</span>
        <span class="n">vpd</span> <span class="o">=</span> <span class="n">vapor_press_deficit</span><span class="p">(</span><span class="n">ambient_h2o</span><span class="p">,</span> <span class="n">leaf_T</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Rvapor</span><span class="o">.</span><span class="n">magnitude</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">vpd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Negative vapor pressure deficit. Check the input data and try again or remove period.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Calculating inside stomata co2 concentration</span>

        <span class="n">ci_mod_const_ppm</span> <span class="o">=</span> <span class="n">ci_const_ppm</span><span class="p">(</span>
            <span class="n">P</span><span class="p">,</span>
            <span class="n">leaf_T</span><span class="p">,</span>
            <span class="n">Constants</span><span class="o">.</span><span class="n">Rco2</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
            <span class="n">Constants</span><span class="o">.</span><span class="n">wue_constants</span><span class="p">[</span><span class="n">ppath</span><span class="p">][</span><span class="s2">&quot;const_ppm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ci_mod_const_ratio</span> <span class="o">=</span> <span class="n">cica_const_ratio</span><span class="p">(</span>
            <span class="n">ambient_co2</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">wue_constants</span><span class="p">[</span><span class="n">ppath</span><span class="p">][</span><span class="s2">&quot;const_ratio&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ci_mod_linear</span> <span class="o">=</span> <span class="n">cica_linear</span><span class="p">(</span>
            <span class="n">ambient_co2</span><span class="p">,</span>
            <span class="n">vpd</span><span class="p">,</span>
            <span class="n">Constants</span><span class="o">.</span><span class="n">wue_constants</span><span class="p">[</span><span class="n">ppath</span><span class="p">][</span><span class="s2">&quot;linear&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">Constants</span><span class="o">.</span><span class="n">wue_constants</span><span class="p">[</span><span class="n">ppath</span><span class="p">][</span><span class="s2">&quot;linear&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">magnitude</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ci_mod_sqrt</span> <span class="o">=</span> <span class="n">cica_sqrt</span><span class="p">(</span>
            <span class="n">ambient_co2</span><span class="p">,</span> <span class="n">vpd</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">wue_constants</span><span class="p">[</span><span class="n">ppath</span><span class="p">][</span><span class="s2">&quot;sqrt&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>

        <span class="c1"># 3 - Compute water use efficiency ----------------------------------------------------------------------------</span>
        <span class="k">for</span> <span class="n">ci</span><span class="p">,</span> <span class="n">mod</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">ci_mod_const_ppm</span><span class="p">,</span> <span class="s2">&quot;const_ppm&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="n">ci_mod_const_ratio</span><span class="p">,</span> <span class="s2">&quot;const_ratio&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="n">ci_mod_linear</span><span class="p">,</span> <span class="s2">&quot;linear&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="n">ci_mod_sqrt</span><span class="p">,</span> <span class="s2">&quot;sqrt&quot;</span><span class="p">],</span>
        <span class="p">]:</span>
            <span class="n">coef</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">Constants</span><span class="o">.</span><span class="n">diff_ratio</span>
            <span class="n">wuei</span> <span class="o">=</span> <span class="n">coef</span> <span class="o">*</span> <span class="p">(</span><span class="n">ambient_co2</span> <span class="o">-</span> <span class="n">ci</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ambient_h2o</span> <span class="o">-</span> <span class="n">inter_h2o</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wue</span><span class="p">[</span><span class="n">mod</span><span class="p">]</span> <span class="o">=</span> <span class="n">wuei</span>

        <span class="c1"># Optimization model from Scanlon et al., 2019 - only applicable to C3 plants</span>
        <span class="k">if</span> <span class="n">ppath</span> <span class="o">==</span> <span class="s2">&quot;C3&quot;</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">varc</span> <span class="o">*</span> <span class="n">cov_wq</span> <span class="o">-</span> <span class="n">corr_qc</span> <span class="o">*</span> <span class="n">sigmaq</span> <span class="o">*</span> <span class="n">sigmac</span> <span class="o">*</span> <span class="n">cov_wc</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">varq</span> <span class="o">*</span> <span class="n">cov_wc</span> <span class="o">-</span> <span class="n">corr_qc</span> <span class="o">*</span> <span class="n">sigmaq</span> <span class="o">*</span> <span class="n">sigmac</span> <span class="o">*</span> <span class="n">cov_wq</span>
            <span class="p">)</span>
            <span class="n">vpdm</span> <span class="o">=</span> <span class="n">vapor_press_deficit_mass</span><span class="p">(</span>
                <span class="n">ambient_h2o</span><span class="p">,</span> <span class="n">leaf_T</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Rvapor</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">vpdm</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wue</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="p">)</span>  <span class="c1"># In case of negative vapor pressure deficit or m</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wue</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">Constants</span><span class="o">.</span><span class="n">diff_ratio</span> <span class="o">*</span> <span class="n">vpdm</span> <span class="o">*</span> <span class="n">m</span>
                    <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                        <span class="n">Constants</span><span class="o">.</span><span class="n">diff_ratio</span>
                        <span class="o">*</span> <span class="n">vpdm</span>
                        <span class="o">*</span> <span class="n">m</span>
                        <span class="o">*</span> <span class="p">(</span><span class="n">ambient_co2</span> <span class="o">+</span> <span class="n">Constants</span><span class="o">.</span><span class="n">diff_ratio</span> <span class="o">*</span> <span class="n">vpdm</span> <span class="o">*</span> <span class="n">m</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Constants</span><span class="o">.</span><span class="n">diff_ratio</span> <span class="o">*</span> <span class="n">vpdm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wue</span><span class="p">[</span><span class="s2">&quot;opt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Model is not suitable for C4 and CAM plants</span>
        <span class="k">del</span> <span class="n">aux</span></div>


<div class="viewcode-block" id="Partitioning.partCEC">
<a class="viewcode-back" href="../../modules.html#partitioning.Partitioning.Partitioning.partCEC">[docs]</a>
    <span class="k">def</span> <span class="nf">partCEC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements the Conditional Eddy Covariance method proposed by Zahn et al. 2021.</span>

<span class="sd">        Direct Partitioning of Eddy-Covariance Water and Carbon Dioxide Fluxes into Ground and Plant Components.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        H : float, optional</span>
<span class="sd">            Hyperbolic threshold, by default 0.0.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        Attributes: self.fluxesCEC</span>
<span class="sd">            Contains all the flux components and status of the calculation.</span>

<span class="sd">            - ET - float</span>
<span class="sd">                Total evapotranspiration (W/m2).</span>
<span class="sd">            - T - float</span>
<span class="sd">                Plant transpiration (W/m2).</span>
<span class="sd">            - Ecec - float</span>
<span class="sd">                Soil/surface evaporation (W/m2).</span>
<span class="sd">            - Fc - float</span>
<span class="sd">                Carbon dioxide flux (mg/m2/s).</span>
<span class="sd">            - Rcec - float</span>
<span class="sd">                Soil/surface respiration (mg/m2/s).</span>
<span class="sd">            - Pcec - float</span>
<span class="sd">                Plant net photosynthesis* (mg/m2/s).</span>
<span class="sd">            - statuscec - str</span>
<span class="sd">                Status of the calculation.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This component represents carboxylation minus photorespiration and leaf respiration; therefore,</span>
<span class="sd">        it is different from gross primary productivity.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">per_points_Q1Q2</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># smallest percentage of points that must be available in the first two quadrants</span>
        <span class="n">per_poits_each</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># smallest percentage of points in each quadrant</span>

        <span class="c1"># Creates a dataframe with variables of interest and no constraints</span>
        <span class="n">auxET</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">auxET</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span>
        <span class="n">total_Fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">auxET</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">auxET</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>  <span class="c1"># flux [all quadrants] given in mg/(s m2)</span>
        <span class="n">total_ET</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auxET</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">auxET</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># flux [all quadrants] given in  W/m2</span>

        <span class="c1"># Creates a dataframe with variables of interest and conditioned on updrafts and on the first quadrant</span>
        <span class="n">auxE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
                <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">][[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]]</span>
        <span class="n">R_condition_Fc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span>  <span class="c1"># conditional flux [1st quadrant and w&#39;&gt;0] given in mg/(s m2)</span>
        <span class="n">E_condition_ET</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span>  <span class="c1"># conditional flux [1st quadrant and w&#39;&gt;0] flux given in  W/m2</span>
        <span class="n">sumQ1</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Percentage of points in the first quadrant</span>

        <span class="c1"># Creates a dataframe with variables of interest and conditioned on updrafts and on the second quadrant</span>
        <span class="n">auxT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
                <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">][[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]]</span>
        <span class="n">P_condition_Fc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span>  <span class="c1"># conditional flux [2nd quadrant and w&#39;&gt;0] given in mg/(s m2)</span>
        <span class="n">T_condition_ET</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span>  <span class="c1"># conditional flux [2nd quadrant and w&#39;&gt;0] flux given in  W/m2</span>
        <span class="n">sumQ2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Percentage of points in the second quadrant</span>

        <span class="c1"># Computing flux ratios and flux components of ET and Fc</span>
        <span class="n">E</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">ratioET</span><span class="p">,</span> <span class="n">ratioRP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># First condition: do we have enough points in Q1 and Q2?</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sumQ1</span> <span class="o">+</span> <span class="n">sumQ2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">per_points_Q1Q2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesCEC</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETcec&quot;</span><span class="p">:</span> <span class="n">total_ET</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Ecec&quot;</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tcec&quot;</span><span class="p">:</span> <span class="n">T</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fccec&quot;</span><span class="p">:</span> <span class="n">total_Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Pcec&quot;</span><span class="p">:</span> <span class="n">P</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rcec&quot;</span><span class="p">:</span> <span class="n">R</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="c1"># &quot;rRPcec&quot;: ratioRP,</span>
                <span class="c1"># &quot;rETcec&quot;: ratioET,</span>
                <span class="s2">&quot;statuscec&quot;</span><span class="p">:</span> <span class="s2">&quot;Q1+Q2&lt;20&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">sumQ1</span> <span class="o">&gt;=</span> <span class="n">per_poits_each</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sumQ2</span> <span class="o">&gt;=</span> <span class="n">per_poits_each</span><span class="p">):</span>
            <span class="c1"># ET components</span>
            <span class="n">ratioET</span> <span class="o">=</span> <span class="n">E_condition_ET</span> <span class="o">/</span> <span class="n">T_condition_ET</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">total_ET</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ratioET</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">total_ET</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">ratioET</span><span class="p">)</span>

            <span class="c1"># Fc components</span>
            <span class="n">ratioRP</span> <span class="o">=</span> <span class="n">R_condition_Fc</span> <span class="o">/</span> <span class="n">P_condition_Fc</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">total_Fc</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ratioRP</span><span class="p">)</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">total_Fc</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">ratioRP</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">sumQ1</span> <span class="o">&lt;</span> <span class="n">per_poits_each</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sumQ2</span> <span class="o">&gt;</span> <span class="n">per_poits_each</span><span class="p">):</span>
            <span class="c1"># In this case, all water vapor flux is assumed to be transpiration</span>
            <span class="n">ratioET</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">total_ET</span>
            <span class="n">E</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1"># In this case, all co2 flux is assumed to be photosynthesis</span>
            <span class="n">ratioRP</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">total_Fc</span>
            <span class="n">R</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">sumQ1</span> <span class="o">&gt;</span> <span class="n">per_poits_each</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sumQ2</span> <span class="o">&lt;</span> <span class="n">per_poits_each</span><span class="p">):</span>
            <span class="c1"># All fluxes are assumed to be from the ground</span>
            <span class="n">ratioET</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">T</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">total_ET</span>
            <span class="c1"># All Fc flux is considered to be respiration</span>
            <span class="n">ratioRP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">P</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">total_Fc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Check CO2 flux components ratio</span>
        <span class="c1">#   CO2 fluxes might be noisy in this range</span>
        <span class="k">if</span> <span class="o">-</span><span class="mf">1.2</span> <span class="o">&lt;</span> <span class="n">ratioRP</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.8</span><span class="p">:</span>
            <span class="n">finalstat</span> <span class="o">=</span> <span class="s2">&quot;Small ratioRP&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finalstat</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span>

        <span class="c1"># Additional constraints may be added based on the strength of the fluxes and other combinations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fluxesCEC</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ETcec&quot;</span><span class="p">:</span> <span class="n">total_ET</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;Ecec&quot;</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;Tcec&quot;</span><span class="p">:</span> <span class="n">T</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;Fccec&quot;</span><span class="p">:</span> <span class="n">total_Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;Pcec&quot;</span><span class="p">:</span> <span class="n">P</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;Rcec&quot;</span><span class="p">:</span> <span class="n">R</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="c1"># &quot;rRP&quot;: ratioRP,</span>
            <span class="c1"># &quot;rET&quot;: ratioET,</span>
            <span class="s2">&quot;statuscec&quot;</span><span class="p">:</span> <span class="n">finalstat</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Partitioning.partREA">
<a class="viewcode-back" href="../../modules.html#partitioning.Partitioning.Partitioning.partREA">[docs]</a>
    <span class="k">def</span> <span class="nf">partREA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements the Modified Relaxed Eddy Accumulation proposed by Thomas et al., 2008 (Agr For Met).</span>

<span class="sd">        Estimating daytime subcanopy respiration from conditional sampling methods applied to multi-scalar high frequency turbulence time series</span>
<span class="sd">        https://www.sciencedirect.com/science/article/pii/S0168192308000737</span>
<span class="sd">        New contraints defined in Zahn et al (2021).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        H : float, optional</span>
<span class="sd">            Hyperbolic threshold, by default 0.0.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        Attributes: self.fluxesREA</span>
<span class="sd">            Dictionary with the following flux components:</span>

<span class="sd">            - ET - float</span>
<span class="sd">                Total evapotranspiration (W/m2).</span>
<span class="sd">            - Tmrea - float</span>
<span class="sd">                Plant transpiration (W/m2).</span>
<span class="sd">            - Emrea - float</span>
<span class="sd">                Soil/surface evaporation (W/m2).</span>
<span class="sd">            - Fc - float</span>
<span class="sd">                Net carbon dioxide flux (mg/m2/s).</span>
<span class="sd">            - Rmrea - float</span>
<span class="sd">                Soil/surface respiration (mg/m2/s).</span>
<span class="sd">            - Pmrea - float</span>
<span class="sd">                Plant net photosynthesis* (mg/m2/s).</span>
<span class="sd">            - statusmrea - str</span>
<span class="sd">                Status of the calculation.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This component represents carboxylation minus photorespiration and leaf respiration; therefore,</span>
<span class="sd">        it is different from gross primary productivity.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">per_points_Q1Q2</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># smallest percentage of points that must be available in the first two quadrants</span>
        <span class="n">per_poits_each</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># smallest percentage of points in each quadrant</span>

        <span class="c1"># REA parameters ---------------------------------------------------</span>
        <span class="n">wseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>  <span class="c1">#  m/s</span>
        <span class="n">cseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>  <span class="c1"># mg/m3</span>
        <span class="n">qseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>  <span class="c1">#  g/m3</span>
        <span class="n">sigmaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">wseries</span><span class="p">)</span>  <span class="c1"># standard deviation of vertical velocity (m/s)</span>
        <span class="n">sigmac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cseries</span><span class="p">)</span>  <span class="c1"># standard deviation of co2 density</span>
        <span class="n">sigmaq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">qseries</span><span class="p">)</span>  <span class="c1"># standard deviation of water vapor density</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">sigmaw</span> <span class="o">/</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wseries</span><span class="p">[</span><span class="n">wseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">wseries</span><span class="p">[</span><span class="n">wseries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>  <span class="c1"># similarity constant</span>
        <span class="n">Fc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">wseries</span><span class="p">,</span> <span class="n">cseries</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># CO2 flux [mg/m2/s]</span>
        <span class="n">ET</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">wseries</span><span class="p">,</span> <span class="n">qseries</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
        <span class="p">)</span>  <span class="c1"># latent heat flux [W/m2]</span>
        <span class="n">NN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">wseries</span><span class="p">)</span>  <span class="c1"># total number of points</span>

        <span class="c1"># For carbon fluxes: numerator and denominator of equation 11 in Thomas et al., 2008</span>
        <span class="n">cnum</span> <span class="o">=</span> <span class="n">cseries</span><span class="p">[</span>
            <span class="p">(</span><span class="n">qseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">cseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">wseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">((</span><span class="n">qseries</span> <span class="o">/</span> <span class="n">sigmaq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">sigmac</span> <span class="o">/</span> <span class="n">cseries</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">((</span><span class="n">cseries</span> <span class="o">/</span> <span class="n">sigmac</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">sigmaq</span> <span class="o">/</span> <span class="n">qseries</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">cdiv</span> <span class="o">=</span> <span class="n">cseries</span><span class="p">[</span>
            <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">qseries</span> <span class="o">/</span> <span class="n">sigmaq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">sigmac</span> <span class="o">/</span> <span class="n">cseries</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">cseries</span> <span class="o">/</span> <span class="n">sigmac</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">sigmaq</span> <span class="o">/</span> <span class="n">qseries</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">wseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># For water vapor fluxes: numerator and denominator of equation 11 in Thomas et al., 2008</span>
        <span class="n">qnum</span> <span class="o">=</span> <span class="n">qseries</span><span class="p">[</span>
            <span class="p">(</span><span class="n">qseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">cseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">wseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">((</span><span class="n">qseries</span> <span class="o">/</span> <span class="n">sigmaq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">sigmac</span> <span class="o">/</span> <span class="n">cseries</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">((</span><span class="n">cseries</span> <span class="o">/</span> <span class="n">sigmac</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">sigmaq</span> <span class="o">/</span> <span class="n">qseries</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">qdiv</span> <span class="o">=</span> <span class="n">qseries</span><span class="p">[</span>
            <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">qseries</span> <span class="o">/</span> <span class="n">sigmaq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">sigmac</span> <span class="o">/</span> <span class="n">cseries</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">cseries</span> <span class="o">/</span> <span class="n">sigmac</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">sigmaq</span> <span class="o">/</span> <span class="n">qseries</span><span class="p">))</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">wseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># Count number of points in the first and second quadrant (no H is used here)</span>
        <span class="n">Q1sum</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cseries</span><span class="p">[(</span><span class="n">qseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span> <span class="o">/</span> <span class="n">NN</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">Q2sum</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cseries</span><span class="p">[(</span><span class="n">qseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cseries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">wseries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)])</span> <span class="o">/</span> <span class="n">NN</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="c1"># Check availability of points in each quadrant</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Q1sum</span> <span class="o">+</span> <span class="n">Q2sum</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">per_points_Q1Q2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesREA</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETmrea&quot;</span><span class="p">:</span> <span class="n">ET</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fcmrea&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Emrea&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tmrea&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Pmrea&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rmrea&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;statusmrea&quot;</span><span class="p">:</span> <span class="s2">&quot;Q1+Q2&lt;20&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">Q1sum</span> <span class="o">&gt;=</span> <span class="n">per_poits_each</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Q2sum</span> <span class="o">&gt;=</span> <span class="n">per_poits_each</span><span class="p">):</span>
            <span class="c1"># Compute fluxes</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">sigmaw</span> <span class="o">*</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">cnum</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">cdiv</span><span class="p">))</span>  <span class="c1"># Respiration [mg / (s m2)]</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">sigmaw</span> <span class="o">*</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">qnum</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">qdiv</span><span class="p">))</span>  <span class="c1"># Evaporation [g / (s m2)]</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>  <span class="c1"># Latent heat flux [W/m2]</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">Fc</span> <span class="o">-</span> <span class="n">R</span>  <span class="c1"># Photosynthesis  [mg/(s m2)]</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">ET</span> <span class="o">-</span> <span class="n">E</span>  <span class="c1"># Transpiration   [W/m2]</span>
            <span class="n">finalstatus</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span>

            <span class="c1"># To test realistic fluxes</span>
            <span class="k">if</span> <span class="n">E</span> <span class="o">&gt;</span> <span class="mf">1.01</span> <span class="o">*</span> <span class="n">ET</span><span class="p">:</span>
                <span class="n">finalstatus</span> <span class="o">=</span> <span class="s2">&quot;E&gt;ET&quot;</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesREA</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETmrea&quot;</span><span class="p">:</span> <span class="n">ET</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fcmrea&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Emrea&quot;</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tmrea&quot;</span><span class="p">:</span> <span class="n">T</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Pmrea&quot;</span><span class="p">:</span> <span class="n">P</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rmrea&quot;</span><span class="p">:</span> <span class="n">R</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;statusmrea&quot;</span><span class="p">:</span> <span class="n">finalstatus</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">Q1sum</span> <span class="o">&lt;</span> <span class="n">per_poits_each</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Q2sum</span> <span class="o">&gt;</span> <span class="n">per_poits_each</span><span class="p">):</span>
            <span class="c1"># Assuming that all fluxes are from the canopy</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesREA</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETmrea&quot;</span><span class="p">:</span> <span class="n">ET</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fcmrea&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Emrea&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tmrea&quot;</span><span class="p">:</span> <span class="n">ET</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Pmrea&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rmrea&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;statusmrea&quot;</span><span class="p">:</span> <span class="s2">&quot;OK&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">Q1sum</span> <span class="o">&gt;</span> <span class="n">per_poits_each</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Q2sum</span> <span class="o">&lt;</span> <span class="n">per_poits_each</span><span class="p">):</span>
            <span class="c1"># Assuming that all fluxes are from the ground</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesREA</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETmrea&quot;</span><span class="p">:</span> <span class="n">ET</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fcmrea&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Emrea&quot;</span><span class="p">:</span> <span class="n">ET</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tmrea&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Pmrea&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rmrea&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;statusmrea&quot;</span><span class="p">:</span> <span class="s2">&quot;OK&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="Partitioning.partFVS">
<a class="viewcode-back" href="../../modules.html#partitioning.Partitioning.Partitioning.partFVS">[docs]</a>
    <span class="k">def</span> <span class="nf">partFVS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">W</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements the Flux Variance Similarity Theory proposed by Scanlon et al., 2019.</span>

<span class="sd">        Direct Partitioning of GPP and Re in a Subalpine Forest Ecosystem.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : float, optional [kg_co2/kg_h2o]</span>
<span class="sd">            Water use efficiency, by default 0.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        Attributes: self.fluxesFVS</span>
<span class="sd">            Contains all the flux components and status of the calculation.</span>

<span class="sd">            - ET - float</span>
<span class="sd">                Total evapotranspiration (W/m2).</span>
<span class="sd">            - Tfvs - float</span>
<span class="sd">                Plant transpiration (W/m2).</span>
<span class="sd">            - Efvs - float</span>
<span class="sd">                Soil/surface evaporation (W/m2).</span>
<span class="sd">            - Fc - float</span>
<span class="sd">                Net carbon dioxide flux (mg/m2/s).</span>
<span class="sd">            - Rfvs - float</span>
<span class="sd">                Soil/surface respiration (mg/m2/s).</span>
<span class="sd">            - Pfvs - float</span>
<span class="sd">                Plant net photosynthesis* (mg/m2/s).</span>
<span class="sd">            - status - str</span>
<span class="sd">                Status of the calculation.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This component represents carboxylation minus photorespiration and leaf respiration; therefore,</span>
<span class="sd">        it is different from gross primary productivity.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">aux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Create dataframe with q, c, and w only</span>
        <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>  <span class="c1"># convert c from mg/m3 to g/m3</span>

        <span class="c1"># Needed statistics ------------------------------------------------</span>
        <span class="n">var_all</span> <span class="o">=</span> <span class="n">aux</span><span class="o">.</span><span class="n">var</span><span class="p">()</span>  <span class="c1"># Variance matrix</span>
        <span class="n">cov_all</span> <span class="o">=</span> <span class="n">aux</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>  <span class="c1"># Covariance matrix</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">aux</span><span class="o">.</span><span class="n">corr</span><span class="p">()[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">][</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span>  <span class="c1"># Correlation coefficient between c and q</span>
        <span class="n">varq</span> <span class="o">=</span> <span class="n">var_all</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span>  <span class="c1"># Variance of q [g/m3]^2</span>
        <span class="n">varc</span> <span class="o">=</span> <span class="n">var_all</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span>  <span class="c1"># Variance of c [g/m3]^2</span>
        <span class="n">sigmaq</span> <span class="o">=</span> <span class="n">varq</span><span class="o">**</span><span class="mf">0.5</span>  <span class="c1"># Standard deviation of q [g/m3]</span>
        <span class="n">sigmac</span> <span class="o">=</span> <span class="n">varc</span><span class="o">**</span><span class="mf">0.5</span>  <span class="c1"># Standard deviation of c [g/m3]</span>
        <span class="n">Fq</span> <span class="o">=</span> <span class="n">cov_all</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span>  <span class="c1"># water vapor flux    [g/m2/s]</span>
        <span class="n">Fc</span> <span class="o">=</span> <span class="n">cov_all</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span>  <span class="c1"># Carbon dioxide flux [g/m2/s]</span>

        <span class="c1"># Check if conditions are satisfied (equations 13a-b from Scanlon 2019)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigmac</span> <span class="o">/</span> <span class="n">sigmaq</span><span class="p">)</span> <span class="o">/</span> <span class="n">rho</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">Fc</span> <span class="o">/</span> <span class="n">Fq</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="p">(</span><span class="n">sigmac</span> <span class="o">/</span> <span class="n">sigmaq</span><span class="p">)</span>

        <span class="c1"># Check mathematical constraints Eq (13) in Scanlon et al., 2019</span>
        <span class="k">if</span> <span class="n">rho</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">A</span> <span class="o">&lt;=</span> <span class="n">B</span> <span class="o">&lt;</span> <span class="n">C</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># constraints 13a</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fluxesFVS</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;ETfvs&quot;</span><span class="p">:</span> <span class="n">Fq</span>
                    <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
                    <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
                    <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s2">&quot;Fcfvs&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                    <span class="s2">&quot;Efvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s2">&quot;Tfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s2">&quot;Pfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                    <span class="s2">&quot;Rfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                    <span class="s2">&quot;statusfvs&quot;</span><span class="p">:</span> <span class="s2">&quot;13a not satisfied&quot;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># if it does not obey, stop here</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">B</span> <span class="o">&lt;</span> <span class="n">C</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># constraints 13b</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fluxesFVS</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;ETfvs&quot;</span><span class="p">:</span> <span class="n">Fq</span>
                    <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
                    <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
                    <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s2">&quot;Fcfvs&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                    <span class="s2">&quot;Efvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s2">&quot;Tfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s2">&quot;Pfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                    <span class="s2">&quot;Rfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                    <span class="s2">&quot;statusfvs&quot;</span><span class="p">:</span> <span class="s2">&quot;13b not satisfied&quot;</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># if it does not obey, stop here</span>

        <span class="c1"># 1 - Calcula var_cp and rho_cpcr (eq. 7 in Scanlon et al., 2019)</span>

        <span class="c1"># Variance cp (7a)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">rho</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">varq</span> <span class="o">*</span> <span class="n">varc</span> <span class="o">*</span> <span class="n">W</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="n">varq</span> <span class="o">*</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">Fc</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sigmaq</span> <span class="o">*</span> <span class="n">sigmac</span> <span class="o">*</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">Fq</span> <span class="o">+</span> <span class="n">varc</span> <span class="o">*</span> <span class="n">Fq</span> <span class="o">*</span> <span class="n">Fq</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">den</span> <span class="o">=</span> <span class="p">(</span><span class="n">varc</span> <span class="o">*</span> <span class="n">Fq</span> <span class="o">+</span> <span class="n">varq</span> <span class="o">*</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">W</span> <span class="o">-</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sigmaq</span> <span class="o">*</span> <span class="n">sigmac</span> <span class="o">*</span> <span class="p">(</span><span class="n">Fc</span> <span class="o">+</span> <span class="n">Fq</span> <span class="o">*</span> <span class="n">W</span><span class="p">))</span> <span class="o">**</span> <span class="mf">2.0</span>
        <span class="n">var_cp</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">den</span>  <span class="c1"># Variance of P</span>
        <span class="c1"># Correlation cp, cr (7b)</span>
        <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">rho</span><span class="p">)</span> <span class="o">*</span> <span class="n">varq</span> <span class="o">*</span> <span class="n">varc</span> <span class="o">*</span> <span class="p">(</span><span class="n">Fc</span> <span class="o">-</span> <span class="n">Fq</span> <span class="o">*</span> <span class="n">W</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span>
        <span class="n">den</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">varq</span> <span class="o">*</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">Fc</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sigmaq</span> <span class="o">*</span> <span class="n">sigmac</span> <span class="o">*</span> <span class="n">Fq</span> <span class="o">*</span> <span class="n">Fc</span> <span class="o">+</span> <span class="n">varc</span> <span class="o">*</span> <span class="n">Fq</span> <span class="o">*</span> <span class="n">Fq</span>
        <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">varc</span> <span class="o">-</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sigmaq</span> <span class="o">*</span> <span class="n">sigmac</span> <span class="o">*</span> <span class="n">W</span> <span class="o">+</span> <span class="n">varq</span> <span class="o">*</span> <span class="n">W</span> <span class="o">*</span> <span class="n">W</span><span class="p">)</span>
        <span class="n">rho_cpcr2</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">den</span>

        <span class="c1"># 2 - Obtain flux components (eq. 6 in Scanlon et al., 2019)</span>

        <span class="c1"># Compute roots and test if they are real</span>

        <span class="n">arg1</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">W</span> <span class="o">*</span> <span class="n">W</span> <span class="o">*</span> <span class="n">varq</span> <span class="o">/</span> <span class="n">var_cp</span><span class="p">)</span> <span class="o">/</span> <span class="n">rho_cpcr2</span>
        <span class="k">if</span> <span class="n">arg1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesFVS</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETfvs&quot;</span><span class="p">:</span> <span class="n">Fq</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
                <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fcfvs&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Efvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Pfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;statusfvs&quot;</span><span class="p">:</span> <span class="s2">&quot;arg1 &lt; 0&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Root is not real; stop partitioning</span>

        <span class="n">arg2</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">varc</span> <span class="o">/</span> <span class="n">var_cp</span><span class="p">)</span> <span class="o">/</span> <span class="n">rho_cpcr2</span>
        <span class="k">if</span> <span class="n">arg2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesFVS</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETfvs&quot;</span><span class="p">:</span> <span class="n">Fq</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
                <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fcfvs&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Efvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Pfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;statusfvs&quot;</span><span class="p">:</span> <span class="s2">&quot;arg2 &lt; 0&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Root is not real; stop partitioning</span>

        <span class="c1"># Roots are real. Proceed to check sign of fluxes</span>
        <span class="n">ratio_ET</span> <span class="o">=</span> <span class="o">-</span><span class="n">rho_cpcr2</span> <span class="o">+</span> <span class="n">rho_cpcr2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">arg1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ratio_ET</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesFVS</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETfvs&quot;</span><span class="p">:</span> <span class="n">Fq</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
                <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fcfvs&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Efvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Pfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;statusfvs&quot;</span><span class="p">:</span> <span class="s2">&quot;rET &lt; 0&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Following imposed constraint that T, E &gt; 0</span>

        <span class="c1"># Test ratio of carbon fluxes: from Fluxpart - Skaggs et al, 2018</span>
        <span class="k">if</span> <span class="n">rho</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sigmac</span> <span class="o">/</span> <span class="n">sigmaq</span> <span class="o">&lt;</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">W</span><span class="p">:</span>
            <span class="n">ratio_RP</span> <span class="o">=</span> <span class="o">-</span><span class="n">rho_cpcr2</span> <span class="o">+</span> <span class="n">rho_cpcr2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">arg2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ratio_RP</span> <span class="o">=</span> <span class="o">-</span><span class="n">rho_cpcr2</span> <span class="o">-</span> <span class="n">rho_cpcr2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">arg2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ratio_RP</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesFVS</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETfvs&quot;</span><span class="p">:</span> <span class="n">Fq</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
                <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fcfvs&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Efvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Pfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rfvs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;statusfvs&quot;</span><span class="p">:</span> <span class="s2">&quot;rRP &gt; 0&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># Following imposed constraint that P&lt;0 and R&gt;0</span>

        <span class="c1"># Obtaining flux components -------------------------------------------------</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">Fq</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ratio_ET</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">Fq</span> <span class="o">-</span> <span class="n">T</span>

        <span class="n">T</span> <span class="o">=</span> <span class="n">T</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>  <span class="c1"># in W/m2</span>
        <span class="n">E</span> <span class="o">=</span> <span class="n">E</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>  <span class="c1"># in W/m2</span>

        <span class="n">P</span> <span class="o">=</span> <span class="n">Fc</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ratio_RP</span><span class="p">)</span>  <span class="c1">#  g/m2/s</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">Fc</span> <span class="o">-</span> <span class="n">P</span>  <span class="c1">#  g/m2/s</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">P</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span>  <span class="c1"># mg/m2/s</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span>  <span class="c1"># mg/m2/s</span>

        <span class="c1"># Convert total fluxes</span>
        <span class="n">Fq</span> <span class="o">=</span> <span class="n">Fq</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>  <span class="c1"># in W/m2</span>
        <span class="n">Fc</span> <span class="o">=</span> <span class="n">Fc</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span>  <span class="c1"># mg/m2/s</span>

        <span class="c1"># Check CO2 flux components ratio</span>
        <span class="c1">#   CO2 fluxes might be noisy in this range</span>
        <span class="n">ratioRP</span> <span class="o">=</span> <span class="n">R</span> <span class="o">/</span> <span class="n">P</span>

        <span class="k">if</span> <span class="o">-</span><span class="mf">1.2</span> <span class="o">&lt;</span> <span class="n">ratioRP</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.8</span><span class="p">:</span>
            <span class="n">finalstat</span> <span class="o">=</span> <span class="s2">&quot;Small ratioRP&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">finalstat</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span>

        <span class="n">finalstat</span>
        <span class="c1"># Add final values to dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fluxesFVS</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ETfvs&quot;</span><span class="p">:</span> <span class="n">Fq</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;Fcfvs&quot;</span><span class="p">:</span> <span class="n">Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;Efvs&quot;</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;Tfvs&quot;</span><span class="p">:</span> <span class="n">T</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;Pfvs&quot;</span><span class="p">:</span> <span class="n">P</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;Rfvs&quot;</span><span class="p">:</span> <span class="n">R</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;statusfvs&quot;</span><span class="p">:</span> <span class="n">finalstat</span><span class="p">,</span>
        <span class="p">}</span></div>


<div class="viewcode-block" id="Partitioning.partCEA">
<a class="viewcode-back" href="../../modules.html#partitioning.Partitioning.Partitioning.partCEA">[docs]</a>
    <span class="k">def</span> <span class="nf">partCEA</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mf">0.00</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements the Conditional Eddy Accumulation method proposed by Zahn et al. 2024.</span>

<span class="sd">        Numerical Investigation of Observational Flux Partitioning Methods for Water Vapor and Carbon Dioxide</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        H : float, optional</span>
<span class="sd">            Hyperbolic threshold, by default 0.0.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        Attributes: self.fluxesCEA</span>
<span class="sd">            Contains all the flux components and status of the calculation.</span>

<span class="sd">            - ET - float</span>
<span class="sd">                Total evapotranspiration (W/m2).</span>
<span class="sd">            - Tcea - float</span>
<span class="sd">                Plant transpiration (W/m2).</span>
<span class="sd">            - Ecea - float</span>
<span class="sd">                Soil/surface evaporation (W/m2).</span>
<span class="sd">            - Fc - float</span>
<span class="sd">                Carbon dioxide flux (mg/m2/s).</span>
<span class="sd">            - Rcea - float</span>
<span class="sd">                Soil/surface respiration (mg/m2/s).</span>
<span class="sd">            - Pcea - float</span>
<span class="sd">                Plant net photosynthesis* (mg/m2/s).</span>
<span class="sd">            - statuscea - str</span>
<span class="sd">                Status of the calculation.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This component represents carboxylation minus photorespiration and leaf respiration; therefore,</span>
<span class="sd">        it is different from gross primary productivity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Creates a dataframe with variables of interest and no constraints</span>
        <span class="n">unitLE</span> <span class="o">=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">auxET</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">auxETcov</span> <span class="o">=</span> <span class="n">auxET</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>  <span class="c1"># covariance</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">auxET</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span>  <span class="c1"># Total number of points</span>
        <span class="n">total_Fc</span> <span class="o">=</span> <span class="n">auxETcov</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span>  <span class="c1"># flux [all quadrants] given in mg/(s m2)</span>
        <span class="n">total_ET</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">auxETcov</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">unitLE</span>
        <span class="p">)</span>  <span class="c1"># flux [all quadrants] given in  W/m2</span>

        <span class="c1"># Creates a dataframe with variables of interest and conditioned on updrafts and on the first quadrant</span>
        <span class="n">auxE</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
                <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">][[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]]</span>
        <span class="n">auxE_n</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
                <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">][[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]]</span>
        <span class="n">C1</span> <span class="o">=</span> <span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">C2</span> <span class="o">=</span> <span class="n">auxE_n</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">Q1</span> <span class="o">=</span> <span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">Q2</span> <span class="o">=</span> <span class="n">auxE_n</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">sum1</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Number of points on the first quadrant</span>
        <span class="n">sum2</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">auxE_n</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Number of points on the first quadrant</span>

        <span class="c1"># Creates a dataframe with variables of interest and conditioned on updrafts and on the second quadrant</span>
        <span class="n">auxT</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
                <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">][[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]]</span>
        <span class="n">auxT_n</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
                <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">][[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]]</span>
        <span class="n">C3</span> <span class="o">=</span> <span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">C4</span> <span class="o">=</span> <span class="n">auxT_n</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">Q3</span> <span class="o">=</span> <span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">Q4</span> <span class="o">=</span> <span class="n">auxT_n</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">sum3</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Number of points on the first quadrant</span>
        <span class="n">sum4</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">auxT_n</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>  <span class="c1"># Number of points on the first quadrant</span>

        <span class="c1"># Computing flux ratios and flux components of ET and Fc</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sum1</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sum2</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sum3</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">sum4</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">ratioET</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q1</span> <span class="o">-</span> <span class="n">Q2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">Q3</span> <span class="o">-</span> <span class="n">Q4</span><span class="p">)</span>
            <span class="n">T</span> <span class="o">=</span> <span class="n">total_ET</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ratioET</span><span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="n">total_ET</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">ratioET</span><span class="p">)</span>

            <span class="n">ratioRP</span> <span class="o">=</span> <span class="p">(</span><span class="n">C1</span> <span class="o">-</span> <span class="n">C2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">C3</span> <span class="o">-</span> <span class="n">C4</span><span class="p">)</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">total_Fc</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">ratioRP</span><span class="p">)</span>
            <span class="n">R</span> <span class="o">=</span> <span class="n">total_Fc</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">ratioRP</span><span class="p">)</span>
            <span class="n">status_message</span> <span class="o">=</span> <span class="s2">&quot;OK&quot;</span>

            <span class="c1"># Check sign of fluxes</span>
            <span class="k">if</span> <span class="n">P</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">P</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">E</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">status_message</span> <span class="o">=</span> <span class="s2">&quot;unrealistic fluxes&quot;</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesCEA</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETcea&quot;</span><span class="p">:</span> <span class="n">total_ET</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Ecea&quot;</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tcea&quot;</span><span class="p">:</span> <span class="n">T</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fccea&quot;</span><span class="p">:</span> <span class="n">total_Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Pcea&quot;</span><span class="p">:</span> <span class="n">P</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rcea&quot;</span><span class="p">:</span> <span class="n">R</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="c1"># &quot;ratioETcea&quot;: ratioET,</span>
                <span class="c1"># &quot;ratioRPcea&quot;: ratioRP,</span>
                <span class="c1">#  &quot;sumQ1cea&quot;: sum1 + sum2,</span>
                <span class="c1">#  &quot;sumQ2cea&quot;: sum3 + sum4,</span>
                <span class="s2">&quot;wuecea&quot;</span><span class="p">:</span> <span class="n">P</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span> <span class="o">/</span> <span class="p">(</span><span class="n">T</span> <span class="o">/</span> <span class="n">unitLE</span><span class="p">),</span>
                <span class="s2">&quot;statuscea&quot;</span><span class="p">:</span> <span class="n">status_message</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesCEA</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETcea&quot;</span><span class="p">:</span> <span class="n">total_ET</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Ecea&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tcea&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fccea&quot;</span><span class="p">:</span> <span class="n">total_Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Pcea&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rcea&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="c1"># &quot;ratioETcea&quot;: np.nan,</span>
                <span class="c1"># &quot;ratioRPcea&quot;: np.nan,</span>
                <span class="c1"># &quot;sumQ1cea&quot;: sum1 + sum2,</span>
                <span class="c1"># &quot;sumQ2cea&quot;: sum3 + sum4,</span>
                <span class="s2">&quot;wuecea&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                <span class="s2">&quot;statuscea&quot;</span><span class="p">:</span> <span class="s2">&quot;Not enough points&quot;</span><span class="p">,</span>
            <span class="p">}</span></div>


<div class="viewcode-block" id="Partitioning.partCECw">
<a class="viewcode-back" href="../../modules.html#partitioning.Partitioning.Partitioning.partCECw">[docs]</a>
    <span class="k">def</span> <span class="nf">partCECw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="mf">0.00</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Implements Conditional Eddy Covariance + water use efficiency proposed by Zahn et al. 2024.</span>

<span class="sd">        Numerical Investigation of Observational Flux Partitioning Methods for Water Vapor and Carbon Dioxide</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        W : float, optional</span>
<span class="sd">            Water use efficiency, by default 0.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        Attributes: self.fluxesCECw</span>
<span class="sd">            Contains all the flux components and status of the calculation.</span>

<span class="sd">            Dictionary with the following flux components:</span>
<span class="sd">            - ET - float</span>
<span class="sd">                Total evapotranspiration (W/m2).</span>
<span class="sd">            - Tcecw - float</span>
<span class="sd">                Plant transpiration (W/m2).</span>
<span class="sd">            - Ececw - float</span>
<span class="sd">                Soil/surface evaporation (W/m2).</span>
<span class="sd">            - Fc - float</span>
<span class="sd">                Net carbon dioxide flux (mg/m2/s).</span>
<span class="sd">            - Rcecw - float</span>
<span class="sd">                Soil/surface respiration (mg/m2/s).</span>
<span class="sd">            - Pcecw - float</span>
<span class="sd">                Plant net photosynthesis* (mg/m2/s).</span>
<span class="sd">            - statuscecw - str</span>
<span class="sd">                Status of the calculation.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This component represents carboxylation minus photorespiration and leaf respiration; therefore,</span>
<span class="sd">        it is different from gross primary productivity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Creates a dataframe with variables of interest and no constraints</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">auxET</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">auxETcov</span> <span class="o">=</span> <span class="n">auxET</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>  <span class="c1"># covariance</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">auxET</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span>  <span class="c1"># Total number of points</span>
        <span class="n">total_Fc</span> <span class="o">=</span> <span class="n">auxETcov</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span>  <span class="c1"># mg/(s m2)</span>
        <span class="n">total_ET</span> <span class="o">=</span> <span class="n">auxETcov</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">][</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span>  <span class="c1"># g/(s m2)</span>

        <span class="k">if</span> <span class="n">W</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">total_Fc</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">total_ET</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesCECw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETcecw&quot;</span><span class="p">:</span> <span class="n">total_ET</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
                <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Ececw&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tcecw&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fccecw&quot;</span><span class="p">:</span> <span class="n">total_Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Pcecw&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rcecw&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># Creates a dataframe with variables of interest and conditioned on updrafts and on the first quadrant</span>
        <span class="n">auxE</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
                <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">][[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]]</span>
        <span class="n">R_condition_Fc</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">N</span>
        <span class="n">E_condition_ET</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">auxE</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">N</span>

        <span class="c1"># Creates a dataframe with variables of interest and conditioned on updrafts and on the second quadrant</span>
        <span class="n">auxT</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span>
                <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
                <span class="o">&gt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">H</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="p">][[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">,</span> <span class="s2">&quot;h2o_p&quot;</span><span class="p">,</span> <span class="s2">&quot;w_p&quot;</span><span class="p">]]</span>
        <span class="n">P_condition_Fc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;co2_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span>  <span class="c1"># conditional flux [2nd quadrant and w&#39;&gt;0] given in mg/(s m2)</span>
        <span class="n">T_condition_ET</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">sum</span><span class="p">(</span><span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;h2o_p&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">auxT</span><span class="p">[</span><span class="s2">&quot;w_p&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">N</span>
        <span class="p">)</span>  <span class="c1"># conditional flux [2nd quadrant and w&#39;&gt;0] flux given in  W/m2</span>

        <span class="c1"># Compute needed parameters (ratios first)</span>
        <span class="k">if</span> <span class="n">T_condition_ET</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ratioET</span> <span class="o">=</span> <span class="n">E_condition_ET</span> <span class="o">/</span> <span class="n">T_condition_ET</span>
            <span class="n">ratioRP</span> <span class="o">=</span> <span class="n">R_condition_Fc</span> <span class="o">/</span> <span class="n">P_condition_Fc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesCECw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETcecw&quot;</span><span class="p">:</span> <span class="n">total_ET</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
                <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Ececw&quot;</span><span class="p">:</span> <span class="n">total_ET</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
                <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tcecw&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fccecw&quot;</span><span class="p">:</span> <span class="n">total_Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Pcecw&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rcecw&quot;</span><span class="p">:</span> <span class="n">total_Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># Compute Z -------------------------------</span>
        <span class="k">if</span> <span class="n">ratioET</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">W</span> <span class="o">*</span> <span class="p">(</span><span class="n">ratioRP</span> <span class="o">/</span> <span class="n">ratioET</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fluxesCECw</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;ETcecw&quot;</span><span class="p">:</span> <span class="n">total_ET</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
                <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Ececw&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Tcecw&quot;</span><span class="p">:</span> <span class="n">total_ET</span>
                <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
                <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
                <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="s2">&quot;Fccecw&quot;</span><span class="p">:</span> <span class="n">total_Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Pcecw&quot;</span><span class="p">:</span> <span class="n">total_Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
                <span class="s2">&quot;Rcecw&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="c1"># Compute flux components -----------------</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_Fc</span> <span class="o">-</span> <span class="n">W</span> <span class="o">*</span> <span class="n">total_ET</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">W</span> <span class="o">/</span> <span class="n">Z</span><span class="p">)</span>  <span class="c1"># in (mg/kg)/m2/s</span>
        <span class="n">P</span> <span class="o">=</span> <span class="n">total_Fc</span> <span class="o">-</span> <span class="n">R</span>  <span class="c1"># in (mg/kg)/m2/s</span>
        <span class="n">E</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">/</span> <span class="n">Z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>  <span class="c1"># in W/m2</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">total_ET</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span> <span class="o">-</span> <span class="n">E</span>  <span class="c1"># in W/m2</span>
        <span class="k">del</span> <span class="n">ratioET</span><span class="p">,</span> <span class="n">ratioRP</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fluxesCECw</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;ETcecw&quot;</span><span class="p">:</span> <span class="n">total_ET</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">3</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">Constants</span><span class="o">.</span><span class="n">Lv</span><span class="o">.</span><span class="n">magnitude</span>
            <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span>
            <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;Ececw&quot;</span><span class="p">:</span> <span class="n">E</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;Tcecw&quot;</span><span class="p">:</span> <span class="n">T</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">watt</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
            <span class="s2">&quot;Fccecw&quot;</span><span class="p">:</span> <span class="n">total_Fc</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;Pcecw&quot;</span><span class="p">:</span> <span class="n">P</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
            <span class="s2">&quot;Rcecw&quot;</span><span class="p">:</span> <span class="n">R</span> <span class="o">*</span> <span class="n">ureg</span><span class="o">.</span><span class="n">milligram</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">meter</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">ureg</span><span class="o">.</span><span class="n">second</span><span class="p">,</span>
        <span class="p">}</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2024, Einara Zahn.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>